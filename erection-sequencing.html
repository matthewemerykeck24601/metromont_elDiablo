<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Erection Sequence Scheduling - Metromont El Diablo</title>
    <link rel="stylesheet" href="https://developer.api.autodesk.com/modelderivative/v2/viewers/7.*/style.min.css">
    <link rel="stylesheet" href="styles/erection-sequencing.css">
    <link rel="stylesheet" href="styles/calculator.css">
</head>
<body class="auth-loading">
    <!-- Auth Processing Overlay -->
    <div class="auth-processing active" id="authProcessing">
        <div class="auth-processing-content">
            <div class="loading"></div>
            <h3 id="authTitle">Initializing 4D Sequencing</h3>
            <p id="authMessage">Loading ACC and AEC Data Model...</p>
        </div>
    </div>

    <header class="header">
        <div class="header-content">
            <div class="logo-section">
                <img src="assets/images/metromont-logo.png" alt="Metromont Logo" class="logo" />
                <div class="brand-text">
                    <h1>Erection Sequence Scheduling</h1>
                    <p>4D Construction Phasing with BIM Integration</p>
                </div>
            </div>
            <div class="nav-breadcrumb">
                <a href="index.html">Dashboard</a>
                <span>→</span>
                <a href="scheduling-hub.html">Scheduling Hub</a>
                <span>→</span>
                <span>Erection Sequencing</span>
            </div>
            <div class="header-buttons">
                <button class="btn btn-back" onclick="window.location.href='scheduling-hub.html'">
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z" />
                    </svg>
                    Back to Hub
                </button>
                <div class="status-badge status-connected" id="authStatusBadge" style="display: none;">
                    <svg width="12" height="12" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z" />
                    </svg>
                    Connected to ACC
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- TOP CONTROL PANEL -->
        <div class="control-panel" id="control-panel">
            <div class="control-section">
                <h3>Project & Model Selection</h3>
                
                <div class="control-group">
                    <label for="esProjectSelect">Project:</label>
                    <select id="esProjectSelect" disabled>
                        <option value="">Loading projects...</option>
                    </select>
                </div>

                <div class="control-group">
                    <label for="esModelSelect">Model (Design):</label>
                    <select id="esModelSelect" disabled>
                        <option value="">Select a project first...</option>
                    </select>
                </div>


                <div class="control-group" style="margin-top: 1rem;">
                    <button class="btn btn-secondary btn-sm" onclick="testAECDataModel()" style="width: 100%;">
                        <svg width="14" height="14" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                        </svg>
                        Test AEC Data Model Status
                    </button>
                    <small>Check if AEC DM is available for selected project</small>
                </div>
            </div>

            <div class="control-section">
                <h3>Schedule Data</h3>
                
                <div class="control-group">
                    <label for="esCsvInput">CSV Schedule:</label>
                    <input type="file" id="esCsvInput" accept=".csv">
                    <button class="btn btn-secondary btn-sm" onclick="useSampleCSV()">
                        <svg width="14" height="14" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z" />
                        </svg>
                        Use Sample CSV
                    </button>
                </div>

                <div id="scheduleInfo" class="schedule-info">
                    <div class="info-item">
                        <span class="info-label">Total Activities:</span>
                        <span class="info-value" id="totalActivities">0</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Date Range:</span>
                        <span class="info-value" id="dateRange">-</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Current Day:</span>
                        <span class="info-value" id="currentDay">-</span>
                    </div>
                </div>
            </div>

            <div class="control-section">
                <h3>Playback Controls</h3>
                
                <div class="playback-controls">
                    <button class="btn btn-primary" id="esBtnPlay" onclick="playSequence()" disabled>
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M8 5v14l11-7z"/>
                        </svg>
                        Play
                    </button>
                    <button class="btn btn-secondary" id="esBtnPause" onclick="pauseSequence()" disabled>
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z"/>
                        </svg>
                        Pause
                    </button>
                    <button class="btn btn-secondary" id="esBtnStep" onclick="stepForward()" disabled>
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M6 4h4v16H6V4zm8 0v16l10-8z"/>
                        </svg>
                        Step
                    </button>
                    <button class="btn btn-secondary" id="esBtnReset" onclick="resetSequence()" disabled>
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12 5V2L8 6l4 4V7c3.31 0 6 2.69 6 6 0 2.97-2.17 5.43-5 5.91v2.02c3.95-.49 7-3.85 7-7.93 0-4.42-3.58-8-8-8z" />
                        </svg>
                        Reset
                    </button>
                </div>

                <div class="timeline-scrubber">
                    <input type="range" id="timelineScrubber" min="0" max="0" value="0" disabled aria-label="Timeline scrubber">
                    <div class="timeline-labels">
                        <span id="timelineStart">-</span>
                        <span id="timelineEnd">-</span>
                    </div>
                </div>
            </div>

            <div class="control-section">
                <h3>Current Activities</h3>
                <div id="currentActivitiesList" class="activities-list">
                    <p class="empty-message">Load a schedule to see activities</p>
                </div>
            </div>
        </div>

        <!-- HORIZONTAL SPLITTER BETWEEN CONTROL PANEL AND VIEWER -->
        <div id="horizontal-splitter" class="ess-horizontal-splitter" aria-label="Resize control panel" title="Drag to resize control panel"></div>

        <!-- VIEWER SECTION -->
        <div class="viewer-section" id="viewer-section">
            <!-- MAIN VERTICAL LAYOUT -->
            <div id="main-vertical" class="ess-vertical">
                <!-- VIEWER PANEL -->
                <div id="viewer-panel" class="ess-viewer-panel">
                    <div class="viewer-toolbar">
                        <button class="viewer-btn" onclick="viewerReset()" title="Reset View">
                            <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 5V2L8 6l4 4V7c3.31 0 6 2.69 6 6 0 2.97-2.17 5.43-5 5.91v2.02c3.95-.49 7-3.85 7-7.93 0-4.42-3.58-8-8-8z" />
                            </svg>
                        </button>
                        <button class="viewer-btn" onclick="viewerFitToView()" title="Fit to View">
                            <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M9 11H7v6h6v-2H9v-4zm-2 8V5h14v14H7z" />
                            </svg>
                        </button>
                        <div class="viewer-separator"></div>
                        <button class="viewer-btn" onclick="viewerIsolate()" title="Isolate Selection">
                            <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" />
                            </svg>
                        </button>
                        <button class="viewer-btn" onclick="viewerShowAll()" title="Show All">
                            <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z" />
                            </svg>
                        </button>
                        <div class="viewer-separator"></div>
                        <button class="viewer-btn" onclick="popOutViewer()" title="Pop Out Viewer">
                            <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z" />
                            </svg>
                        </button>
                        <div class="viewer-info">
                            <span id="viewerInfo">Select a model to begin</span>
                        </div>
                    </div>
                    
                    <div id="esViewer" class="viewer-container">
                        <div class="loading-message">
                            <p>Select a project and model to load the 3D viewer</p>
                        </div>
                    </div>

                    <div id="viewerStatus" class="viewer-status">
                        <span id="viewerStatusText">Ready</span>
                    </div>
                </div>

                <!-- HORIZONTAL SPLITTER / GRAB BAR -->
                <div id="splitter" class="ess-splitter" aria-label="Resize viewer" title="Drag to resize" style="display:none;"></div>

                <!-- BOTTOM PANEL -->
                <div id="bottom-panel" class="ess-bottom-panel" style="display:none;">
                    <!-- Model Properties header row -->
                    <div class="ess-properties-header">
                        <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
                            <strong>Model Properties</strong>
                            <button id="btnPopOutGrid" class="btn btn-secondary btn-sm" title="Open in new window">
                                <svg width="14" height="14" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M19 19H5V5h7V3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2v-7h-2v7zM14 3v2h3.59l-9.83 9.83 1.41 1.41L19 6.41V10h2V3h-7z"/>
                                </svg>
                                Pop Out
                            </button>
                            <button id="btnExportPropGrid" class="btn btn-secondary btn-sm">Export CSV</button>
                        </div>

                        <div class="propgrid-toolbar">
                            <label for="propGridSavedFormat" style="margin-right:.5rem;">Saved format:</label>
                            <select id="propGridSavedFormat" aria-label="Saved format" style="min-width:220px;">
                                <option value="Default">Default (Category → CONTROL_MARK → CONTROL_NUMBER)</option>
                            </select>
                            <button id="btnEditGrouping" class="btn" style="margin-left:.5rem;">Grouping…</button>
                            <button id="btnAddColumn" class="btn" style="margin-left:.5rem;">+ Column</button>
                            <button id="btnAddExtendedParamsToolbar" class="btn" style="margin-left:.5rem;">+ Properties…</button>
                            <span id="propGridStatus" class="muted" style="margin-left:1rem;"></span>
                            <div style="margin-left:auto;">
                                <button id="btnLoadPropGrid" class="btn btn-primary">Load properties table</button>
                            </div>
                        </div>
                    </div>

                    <!-- TABLE SCROLLER (adds horizontal + vertical scrollbars) -->
                    <div id="properties-scroll" class="ess-table-scroll">
                        <table id="propGrid" class="ess-properties-table">
                            <thead>
                                <tr>
                                    <th>Category</th>
                                    <th>CONTROL_MARK</th>
                                    <th>CONTROL_NUMBER</th>
                                    <th>Family</th>
                                    <th>Type Name</th>
                                    <th>Element ID</th>
                                    <th>Level</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Toast -->
    <div id="notification" class="notification">
        <div class="notification-content" id="notificationContent"></div>
    </div>

    <!-- Column Picker Modal -->
    <div id="columnPickerModal" class="modal" style="display:none;">
      <div class="modal-content" style="max-width:600px;">
        <div class="modal-header">
          <h3>Add Custom Column</h3>
          <button id="columnPickerClose" class="btn-icon" aria-label="Close">✕</button>
        </div>

        <div class="modal-body">
          <p class="muted" style="margin-bottom:1rem;">Select a property from the canonical property map to add as a column:</p>
          
          <div style="margin-bottom:1rem;">
            <input id="columnSearch" type="search" placeholder="Search properties..." style="width:100%; padding:.5rem; border:1px solid #ddd; border-radius:4px;">
          </div>

          <div style="max-height:400px; overflow-y:auto; border:1px solid #ddd; border-radius:4px;">
            <ul id="columnPickerList" class="list selectable" style="list-style:none; margin:0; padding:0;">
              <!-- Dynamically populated -->
            </ul>
          </div>
        </div>

        <div class="modal-footer" style="display:flex; justify-content:flex-end; gap:.5rem;">
          <button id="columnPickerCancel" class="btn">Cancel</button>
          <button id="columnPickerAdd" class="btn btn-primary">Add Column</button>
        </div>
      </div>
    </div>

    <!-- Grouping Modal -->
    <div id="groupingModal" class="modal" style="display:none;">
      <div class="modal-content" style="max-width:900px;">
        <div class="modal-header">
          <h3>Edit grouping</h3>
          <button id="groupingClose" class="btn-icon" aria-label="Close">✕</button>
        </div>

        <div class="modal-body" style="display:flex; gap:1rem;">
          <!-- Available properties -->
          <div style="flex:1; min-width:320px;">
            <div class="muted" style="margin-bottom:.25rem;">Add properties</div>
            <input id="groupAvailSearch" type="search" placeholder="Search…" style="width:100%; margin-bottom:.5rem;">
            <div class="accordion">
              <details open>
                <summary>Common properties</summary>
                <ul id="groupingCommonList" class="list selectable"></ul>
              </details>
              <details>
                <summary>Extended properties</summary>
                <div style="display:flex;justify-content:space-between;align-items:center;margin:.25rem 0 .5rem 0;">
                  <button id="btnAddExtendedParams" class="btn btn-sm">Add properties…</button>
                </div>
                <ul id="groupingExtendedList" class="list selectable"></ul>
              </details>
              <details>
                <summary>Model properties</summary>
                <ul id="groupingModelList" class="list selectable"></ul>
              </details>
            </div>
          </div>

          <!-- Grouping order -->
          <div style="flex:1; min-width:320px;">
            <div class="muted" style="margin-bottom:.25rem;">Grouping order</div>
            <input id="groupOrderSearch" type="search" placeholder="Search…" style="width:100%; margin-bottom:.5rem;">
            <ul id="groupingOrderList" class="list sortable"></ul>
          </div>
        </div>

        <div class="modal-footer" style="display:flex; justify-content:flex-end; gap:.5rem;">
          <button id="groupingCancel" class="btn">Cancel</button>
          <button id="groupingApply" class="btn btn-primary">Apply</button>
        </div>
      </div>
    </div>

    <!-- Extended Parameters Picker Modal -->
    <div id="extendedParamsModal" class="modal" style="display:none;">
      <div class="modal-content" style="max-width:720px;">
        <div class="modal-header">
          <h3>Add properties from Parameter Service</h3>
          <button id="extParamsClose" class="btn-icon" aria-label="Close">✕</button>
        </div>
        <div class="modal-body">
          <input id="extParamsSearch" type="search" placeholder="Search parameters…" style="width:100%;margin-bottom:.5rem;">
          <div id="extParamsList" style="max-height:420px;overflow:auto;border:1px solid #ddd;border-radius:4px;padding:.5rem;"></div>
        </div>
        <div class="modal-footer" style="display:flex;justify-content:flex-end;gap:.5rem;">
          <button id="extParamsCancel" class="btn">Cancel</button>
          <button id="extParamsAdd" class="btn btn-primary">Add Selected</button>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script src="scripts/env.js"></script>
    <script src="https://developer.api.autodesk.com/modelderivative/v2/viewers/7.*/viewer3D.min.js"></script>
    <script type="module" src="scripts/aecdm-graphql.js"></script>
    <script type="module" src="scripts/erection-sequencing.js"></script>
</body>
</html>

