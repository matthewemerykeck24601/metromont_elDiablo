<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Erection Sequence Scheduling - Metromont El Diablo</title>
    <link rel="stylesheet" href="https://developer.api.autodesk.com/modelderivative/v2/viewers/7.*/style.min.css">
    <link rel="stylesheet" href="styles/erection-sequencing.css">
</head>
<body class="auth-loading">
    <!-- Auth Processing Overlay -->
    <div class="auth-processing active" id="authProcessing">
        <div class="auth-processing-content">
            <div class="loading"></div>
            <h3 id="authTitle">Initializing 4D Sequencing</h3>
            <p id="authMessage">Loading ACC and AEC Data Model...</p>
        </div>
    </div>

    <header class="header">
        <div class="header-content">
            <div class="logo-section">
                <img src="assets/images/metromont-logo.png" alt="Metromont Logo" class="logo" />
                <div class="brand-text">
                    <h1>Erection Sequence Scheduling</h1>
                    <p>4D Construction Phasing with BIM Integration</p>
                </div>
            </div>
            <div class="nav-breadcrumb">
                <a href="index.html">Dashboard</a>
                <span>→</span>
                <a href="scheduling-hub.html">Scheduling Hub</a>
                <span>→</span>
                <span>Erection Sequencing</span>
            </div>
            <div class="header-buttons">
                <button class="btn btn-back" onclick="window.location.href='scheduling-hub.html'">
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z" />
                    </svg>
                    Back to Hub
                </button>
                <div class="status-badge status-connected" id="authStatusBadge" style="display: none;">
                    <svg width="12" height="12" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z" />
                    </svg>
                    Connected to ACC
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Control Panel -->
        <div class="control-panel">
            <div class="control-section">
                <h3>Project & Model Selection</h3>
                
                <div class="control-group">
                    <label for="esProjectSelect">Project:</label>
                    <select id="esProjectSelect" disabled>
                        <option value="">Loading projects...</option>
                    </select>
                </div>

                <div class="control-group">
                    <label for="esModelSelect">Model (Design):</label>
                    <select id="esModelSelect" disabled>
                        <option value="">Select a project first...</option>
                    </select>
                </div>

                <div class="control-group">
                    <label>Element Filters:</label>
                    <div id="elementFiltersContainer">
                        <div class="filter-row" data-filter-id="0">
                            <select class="filter-category" id="filterCategory0" aria-label="Element category" disabled onchange="onCategoryChange(0)">
                                <option value="">Load a model first...</option>
                            </select>
                            <select class="filter-property" id="filterProperty0" aria-label="Element property" disabled>
                                <option value="">Select category first...</option>
                            </select>
                            <button class="btn-icon btn-remove-filter" onclick="removeFilter(0)" style="display: none;" title="Remove filter" aria-label="Remove filter">
                                ✕
                            </button>
                        </div>
                    </div>
                    <button class="btn btn-secondary btn-sm" id="btnAddFilter" onclick="addFilterRow()" disabled style="margin-top: 0.5rem;">
                        <svg width="14" height="14" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                        </svg>
                        Add Filter
                    </button>
                    <small>Select element category and property to link activities</small>
                </div>

                <div class="control-group" style="margin-top: 1rem;">
                    <button class="btn btn-secondary btn-sm" onclick="testAECDataModel()" style="width: 100%;">
                        <svg width="14" height="14" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                        </svg>
                        Test AEC Data Model Status
                    </button>
                    <small>Check if AEC DM is available for selected project</small>
                </div>
            </div>

            <div class="control-section">
                <h3>Schedule Data</h3>
                
                <div class="control-group">
                    <label for="esCsvInput">CSV Schedule:</label>
                    <input type="file" id="esCsvInput" accept=".csv">
                    <button class="btn btn-secondary btn-sm" onclick="useSampleCSV()">
                        <svg width="14" height="14" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z" />
                        </svg>
                        Use Sample CSV
                    </button>
                </div>

                <div id="scheduleInfo" class="schedule-info">
                    <div class="info-item">
                        <span class="info-label">Total Activities:</span>
                        <span class="info-value" id="totalActivities">0</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Date Range:</span>
                        <span class="info-value" id="dateRange">-</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Current Day:</span>
                        <span class="info-value" id="currentDay">-</span>
                    </div>
                </div>
            </div>

            <div class="control-section">
                <h3>Playback Controls</h3>
                
                <div class="playback-controls">
                    <button class="btn btn-primary" id="esBtnPlay" onclick="playSequence()" disabled>
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M8 5v14l11-7z"/>
                        </svg>
                        Play
                    </button>
                    <button class="btn btn-secondary" id="esBtnPause" onclick="pauseSequence()" disabled>
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z"/>
                        </svg>
                        Pause
                    </button>
                    <button class="btn btn-secondary" id="esBtnStep" onclick="stepForward()" disabled>
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M6 4h4v16H6V4zm8 0v16l10-8z"/>
                        </svg>
                        Step
                    </button>
                    <button class="btn btn-secondary" id="esBtnReset" onclick="resetSequence()" disabled>
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12 5V2L8 6l4 4V7c3.31 0 6 2.69 6 6 0 2.97-2.17 5.43-5 5.91v2.02c3.95-.49 7-3.85 7-7.93 0-4.42-3.58-8-8-8z" />
                        </svg>
                        Reset
                    </button>
                </div>

                <div class="timeline-scrubber">
                    <input type="range" id="timelineScrubber" min="0" max="0" value="0" disabled aria-label="Timeline scrubber">
                    <div class="timeline-labels">
                        <span id="timelineStart">-</span>
                        <span id="timelineEnd">-</span>
                    </div>
                </div>
            </div>

            <div class="control-section">
                <h3>Current Activities</h3>
                <div id="currentActivitiesList" class="activities-list">
                    <p class="empty-message">Load a schedule to see activities</p>
                </div>
            </div>
        </div>

        <!-- Viewer Section -->
        <div class="viewer-section">
            <div class="viewer-toolbar">
                <button class="viewer-btn" onclick="viewerReset()" title="Reset View">
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12 5V2L8 6l4 4V7c3.31 0 6 2.69 6 6 0 2.97-2.17 5.43-5 5.91v2.02c3.95-.49 7-3.85 7-7.93 0-4.42-3.58-8-8-8z" />
                    </svg>
                </button>
                <button class="viewer-btn" onclick="viewerFitToView()" title="Fit to View">
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M9 11H7v6h6v-2H9v-4zm-2 8V5h14v14H7z" />
                    </svg>
                </button>
                <div class="viewer-separator"></div>
                <button class="viewer-btn" onclick="viewerIsolate()" title="Isolate Selection">
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" />
                    </svg>
                </button>
                <button class="viewer-btn" onclick="viewerShowAll()" title="Show All">
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z" />
                    </svg>
                </button>
                <div class="viewer-info">
                    <span id="viewerInfo">Select a model to begin</span>
                </div>
            </div>
            
            <div id="esViewer" class="viewer-container">
                <div class="loading-message">
                    <p>Select a project and model to load the 3D viewer</p>
                </div>
            </div>

            <div id="viewerStatus" class="viewer-status">
                <span id="viewerStatusText">Ready</span>
            </div>

            <!-- Properties Grid Panel -->
            <section id="properties-grid-panel" style="display:none; border-top:1px solid #e5e7eb; padding:12px 8px; background: white;">
                <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
                    <strong>Model Properties</strong>
                    <button id="btnExportPropGrid" class="btn btn-secondary btn-sm">Export CSV</button>
                </div>

                <div class="propgrid-toolbar">
                  <label for="propGridSavedFormat" style="margin-right:.5rem;">Saved format:</label>
                  <select id="propGridSavedFormat" aria-label="Saved format" style="min-width:220px;">
                    <option value="Default">Default (Category → Family → Type Name → Mark)</option>
                  </select>
                  <button id="btnEditGrouping" class="btn" style="margin-left:.5rem;">Grouping…</button>
                  <span id="propGridStatus" class="muted" style="margin-left:1rem;"></span>
                  <div style="margin-left:auto;">
                    <button id="btnLoadPropGrid" class="btn btn-primary">Load properties table</button>
                  </div>
                </div>

                <div style="overflow:auto; max-height:360px; border:1px solid #e5e7eb; margin-top:8px;">
                    <table id="propGrid" style="width:100%; border-collapse:collapse;">
                        <thead style="position:sticky; top:0; background:#f9fafb;">
                            <tr>
                                <th style="text-align:left; padding:6px; border-bottom:1px solid #e5e7eb;">Category</th>
                                <th style="text-align:left; padding:6px; border-bottom:1px solid #e5e7eb;">Family</th>
                                <th style="text-align:left; padding:6px; border-bottom:1px solid #e5e7eb;">Type Name</th>
                                <th style="text-align:left; padding:6px; border-bottom:1px solid #e5e7eb;">Mark</th>
                                <th style="text-align:left; padding:6px; border-bottom:1px solid #e5e7eb;">Element ID</th>
                                <th style="text-align:left; padding:6px; border-bottom:1px solid #e5e7eb;">Level</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </section>
        </div>
    </div>

    <!-- Notification Toast -->
    <div id="notification" class="notification">
        <div class="notification-content" id="notificationContent"></div>
    </div>

    <!-- Grouping Modal -->
    <div id="groupingModal" class="modal" style="display:none;">
      <div class="modal-content" style="max-width:900px;">
        <div class="modal-header">
          <h3>Edit grouping</h3>
          <button id="groupingClose" class="btn-icon" aria-label="Close">✕</button>
        </div>

        <div class="modal-body" style="display:flex; gap:1rem;">
          <!-- Available properties -->
          <div style="flex:1; min-width:320px;">
            <div class="muted" style="margin-bottom:.25rem;">Add properties</div>
            <input id="groupAvailSearch" type="search" placeholder="Search…" style="width:100%; margin-bottom:.5rem;">
            <details open>
              <summary>Common properties</summary>
              <ul id="groupAvailCommon" class="list selectable"></ul>
            </details>
            <details>
              <summary>Extended properties</summary>
              <ul id="groupAvailExtended" class="list selectable"></ul>
            </details>
            <details>
              <summary>Model properties</summary>
              <ul id="groupAvailModel" class="list selectable"></ul>
            </details>
          </div>

          <!-- Grouping order -->
          <div style="flex:1; min-width:320px;">
            <div class="muted" style="margin-bottom:.25rem;">Grouping order</div>
            <input id="groupOrderSearch" type="search" placeholder="Search…" style="width:100%; margin-bottom:.5rem;">
            <ul id="groupOrder" class="list sortable"></ul>
          </div>
        </div>

        <div class="modal-footer" style="display:flex; justify-content:flex-end; gap:.5rem;">
          <button id="groupingCancel" class="btn">Cancel</button>
          <button id="groupingApply" class="btn btn-primary">Apply</button>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script src="scripts/env.js"></script>
    <script src="https://developer.api.autodesk.com/modelderivative/v2/viewers/7.*/viewer3D.min.js"></script>
    <script src="scripts/aecdm-graphql.js"></script>
    <script src="scripts/erection-sequencing.js"></script>
</body>
</html>

