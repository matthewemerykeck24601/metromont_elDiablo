<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Production Scheduling - Precast Bed Scheduler | Metromont CastLink</title>
    <link rel="stylesheet" href="styles/production-scheduling.css">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; connect-src 'self' https://developer.api.autodesk.com;">
</head>
<body class="auth-loading">
    <!-- Auth Processing Overlay -->
    <div class="auth-processing active" id="authProcessing">
        <div class="auth-processing-content">
            <div class="loading"></div>
            <h3 id="authTitle">Initializing Production Scheduler</h3>
            <p id="authMessage">Loading ACC Assets and bed configurations...</p>
        </div>
    </div>

    <header class="header">
        <div class="header-content">
            <div class="logo-section">
                <img src="assets/images/metromont-logo.png" alt="Metromont Logo" class="logo" />
                <div class="brand-text">
                    <h1>Production Scheduling</h1>
                    <p>Intelligent Precast Bed Scheduler</p>
                </div>
            </div>
            <div class="nav-breadcrumb">
                <a href="index.html">Dashboard</a>
                <span>→</span>
                <span>Production Scheduling</span>
            </div>
            <div class="header-buttons">
                <button class="btn btn-back" onclick="window.location.href='index.html'">
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z" />
                    </svg>
                    Back to Dashboard
                </button>
                <div class="status-badge status-connected" id="authStatusBadge" style="display: none;">
                    <svg width="12" height="12" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z" />
                    </svg>
                    Connected to ACC
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Top Layout with Controls and 3D Viewer -->
        <div class="top-layout">
            <!-- Control Panel -->
            <div class="control-panel">
                <div class="control-section">
                    <h3>Schedule Controls</h3>
                    <div class="control-group">
                        <label for="projectSelect">Project:</label>
                        <select id="projectSelect" disabled>
                            <option value="">Loading projects...</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label for="typeSelect">Type:</label>
                        <select id="typeSelect">
                            <option value="">-</option>
                            <option value="beam">Beam</option>
                            <option value="column">Column</option>
                            <option value="wall">Wall Panel</option>
                            <option value="doubletee">Double Tee</option>
                            <option value="slab">Slab</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label for="lengthInput">Length:</label>
                        <input type="number" id="lengthInput" placeholder="-" />
                    </div>
                    <div class="control-group">
                        <label for="widthInput">Width:</label>
                        <input type="number" id="widthInput" placeholder="-" />
                    </div>
                </div>

                <div class="control-section">
                    <h3>Bed Information</h3>
                    <div class="bed-info">
                        <div class="info-item">
                            <span class="info-label">Type:</span>
                            <span class="info-value" id="bedType">Select a bed</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Length:</span>
                            <span class="info-value" id="bedLength">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Width:</span>
                            <span class="info-value" id="bedWidth">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Utilization:</span>
                            <span class="info-value" id="bedUtilization">0%</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Pieces:</span>
                            <span class="info-value" id="pieceCount">0</span>
                        </div>
                    </div>
                </div>

                <div class="control-section">
                    <h3>Schedule Status</h3>
                    <div class="schedule-status">
                        <div class="status-item">
                            <label for="dateSelect">Date Scheduled:</label>
                            <input type="date" id="dateSelect" onchange="onDateChange()" />
                        </div>
                        <div class="status-item">
                            <label for="datePoured">Date Poured:</label>
                            <input type="date" id="datePoured" onchange="updateScheduleStatus()" />
                        </div>
                        <div class="status-item">
                            <label for="bedSelect">Production Bed:</label>
                            <select id="bedSelect" onchange="onBedChange()">
                                <option value="">Select a bed...</option>
                                <option value="beam">Beam Bed</option>
                                <option value="deck1">Deck Bed 1</option>
                                <option value="deck2">Deck Bed 2</option>
                                <option value="flatbed1">Flat Bed 1</option>
                                <option value="flatbed2">Flat Bed 2</option>
                                <option value="flatbed3">Flat Bed 3</option>
                                <option value="flatbed4">Flat Bed 4</option>
                                <option value="flatbed5">Flat Bed 5</option>
                                <option value="flatbed6">Flat Bed 6</option>
                                <option value="flatbed7">Flat Bed 7</option>
                            </select>
                        </div>
                        <div class="status-item">
                            <label for="statusSelect">Status:</label>
                            <select id="statusSelect" onchange="updateScheduleStatus()">
                                <option value="Available">Available</option>
                                <option value="Scheduled">Scheduled</option>
                                <option value="In Progress">In Progress</option>
                                <option value="Complete">Complete</option>
                            </select>
                        </div>
                        <div class="status-item">
                            <label for="pourStatus">Pour Status:</label>
                            <select id="pourStatus" onchange="updateScheduleStatus()">
                                <option value="Scheduled">Scheduled</option>
                                <option value="Ready">Ready</option>
                                <option value="Pouring">Pouring</option>
                                <option value="Complete">Complete</option>
                                <option value="Curing">Curing</option>
                            </select>
                        </div>
                        <div class="status-item">
                            <label for="designNumber">Design #:</label>
                            <select id="designNumber">
                                <option value="">None</option>
                                <option value="DT-001">DT-001</option>
                                <option value="BM-001">BM-001</option>
                                <option value="COL-001">COL-001</option>
                            </select>
                        </div>
                        <div class="status-item">
                            <label for="piecesInput">Pieces:</label>
                            <input type="number" id="piecesInput" value="0" min="0" onchange="updateScheduleStatus()" />
                        </div>
                    </div>
                    <div class="control-actions">
                        <button class="btn btn-primary" id="saveScheduleBtn" onclick="saveSchedule()">
                            <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/>
                            </svg>
                            Save Schedule
                        </button>
                        <button class="btn btn-secondary" id="toggleViewBtn" onclick="toggleView()">
                            <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
                            </svg>
                            Toggle View
                        </button>
                    </div>
                </div>
            </div>

            <!-- Viewer Section -->
            <div class="viewer-section">
                <!-- Main Viewer -->
                <div class="viewer-container">
                    <div class="viewer-toolbar">
                        <button class="viewer-btn" onclick="resetCamera()" title="Reset Camera">
                            <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 5V2L8 6l4 4V7c3.31 0 6 2.69 6 6 0 2.97-2.17 5.43-5 5.91v2.02c3.95-.49 7-3.85 7-7.93 0-4.42-3.58-8-8-8z"/>
                            </svg>
                        </button>
                        <button class="viewer-btn" onclick="fitToView()" title="Fit to View">
                            <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M9 11H7v6h6v-2H9v-4zm-2 8V5h14v14H7z"/>
                            </svg>
                        </button>
                        <div class="viewer-separator"></div>
                        <button class="viewer-btn" onclick="toggleWireframe()" title="Toggle Wireframe">
                            <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                            </svg>
                        </button>
                        <button class="viewer-btn" onclick="toggleStrandPattern()" title="Toggle Strand Pattern">
                            <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                            </svg>
                        </button>
                        <div class="viewer-info">
                            <span id="viewerInfo">Select a bed to begin</span>
                        </div>
                    </div>
                    <div id="threejsContainer"></div>
                </div>

                <!-- Validation Panel -->
                <div class="validation-panel">
                    <h3>Validation Issues</h3>
                    <div id="validationMessages">
                        <div class="loading-message">No issues detected</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom Assets Panel -->
        <div class="bottom-assets-panel">
            <div class="assets-header">
                <h3>Available Pieces</h3>
                <div class="assets-controls">
                    <input type="text" id="assetSearch" placeholder="Search by mark or design..." />
                    <select id="modelFilter">
                        <option value="">Select Model...</option>
                    </select>
                    <select id="typeFilter">
                        <option value="">All Types</option>
                        <option value="beam">Beam</option>
                        <option value="column">Column</option>
                        <option value="wall">Wall</option>
                        <option value="doubletee">Double Tee</option>
                        <option value="slab">Slab</option>
                    </select>
                </div>
            </div>
            <div class="assets-content">
                <div class="assets-grid" id="assetsGrid">
                    <div class="loading-message">Loading assets...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Piece Details Modal -->
    <div class="modal-overlay" id="pieceDetailsModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Piece Details</h3>
                <button class="modal-close" onclick="closePieceDetails()">×</button>
            </div>
            <div class="modal-content" id="pieceDetailsContent">
                <!-- Dynamic content -->
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closePieceDetails()">Cancel</button>
                <button class="btn btn-primary" onclick="savePieceChanges()">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Load Three.js and OrbitControls -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        // Load OrbitControls after Three.js is loaded
        function loadOrbitControls() {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js';
                script.onload = () => {
                    // Define OrbitControls inline to avoid external script issues
                    if (typeof THREE !== 'undefined') {
                        // Simple OrbitControls implementation
                        THREE.OrbitControls = function(camera, domElement) {
                            this.camera = camera;
                            this.domElement = domElement;
                            this.enabled = true;
                            this.enableDamping = true;
                            this.dampingFactor = 0.05;
                            this.minDistance = 10;
                            this.maxDistance = 500;
                            this.maxPolarAngle = Math.PI / 2;
                            
                            // Basic orbit functionality
                            let isMouseDown = false;
                            let mouseX = 0, mouseY = 0;
                            let phi = 0, theta = 0;
                            
                            this.domElement.addEventListener('mousedown', (e) => {
                                isMouseDown = true;
                                mouseX = e.clientX;
                                mouseY = e.clientY;
                            });
                            
                            this.domElement.addEventListener('mousemove', (e) => {
                                if (!isMouseDown) return;
                                const deltaX = e.clientX - mouseX;
                                const deltaY = e.clientY - mouseY;
                                theta -= deltaX * 0.01;
                                phi += deltaY * 0.01;
                                phi = Math.max(-Math.PI/2, Math.min(Math.PI/2, phi));
                                this.updateCameraPosition();
                                mouseX = e.clientX;
                                mouseY = e.clientY;
                            });
                            
                            this.domElement.addEventListener('mouseup', () => {
                                isMouseDown = false;
                            });
                            
                            this.domElement.addEventListener('wheel', (e) => {
                                const distance = this.camera.position.length();
                                const newDistance = Math.max(this.minDistance, Math.min(this.maxDistance, distance + e.deltaY * 0.1));
                                this.camera.position.normalize().multiplyScalar(newDistance);
                            });
                            
                            this.updateCameraPosition = () => {
                                const distance = this.camera.position.length();
                                this.camera.position.x = distance * Math.sin(theta) * Math.cos(phi);
                                this.camera.position.y = distance * Math.sin(phi);
                                this.camera.position.z = distance * Math.cos(theta) * Math.cos(phi);
                                this.camera.lookAt(0, 0, 0);
                            };
                            
                            this.update = () => {
                                // Damping can be implemented here
                            };
                        };
                        resolve();
                    } else {
                        reject(new Error('Three.js not loaded'));
                    }
                };
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                console.log('Production Scheduling module loaded');
                // Wait for OrbitControls to be available
                if (typeof THREE === 'undefined') {
                    await new Promise(resolve => {
                        const checkThree = () => {
                            if (typeof THREE !== 'undefined') {
                                resolve();
                            } else {
                                setTimeout(checkThree, 100);
                            }
                        };
                        checkThree();
                    });
                }
                await loadOrbitControls();
                // Initialize the app
                initializeApp();
            } catch (error) {
                console.error('Failed to initialize:', error);
                showAuthError('Failed to load required dependencies: ' + error.message);
            }
        });
    </script>
    <script src="scripts/production-scheduling.js"></script>
</body>
</html>