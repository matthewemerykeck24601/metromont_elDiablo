<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="frame-ancestors 'self' https://*.autodesk.com https://*.autodeskbim360.com https://*.acc.autodesk.com;">
    <title>PPPQC Stressing Calculator - ACC Connect</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(135deg, #eff6ff 0%, #e0e7ff 100%);
            min-height: 100vh;
            padding: 16px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-icon {
            width: 32px;
            height: 32px;
            color: #2563eb;
        }

        .header-title h1 {
            font-size: 20px;
            font-weight: bold;
            color: #1f2937;
        }

        .header-title p {
            font-size: 14px;
            color: #6b7280;
        }

        .header-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-save { background: #059669; color: white; }
        .btn-save:hover:not(:disabled) { background: #047857; }
        .btn-print { background: #2563eb; color: white; }
        .btn-print:hover:not(:disabled) { background: #1d4ed8; }
        .btn-export { background: #7c3aed; color: white; }
        .btn-export:hover:not(:disabled) { background: #6d28d9; }

        .card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            padding: 16px;
            margin-bottom: 16px;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-connected {
            background: #dcfce7;
            color: #166534;
        }

        .status-disconnected {
            background: #fee2e2;
            color: #991b1b;
        }

        .grid {
            display: grid;
            gap: 16px;
        }

        .grid-cols-2 {
            grid-template-columns: 1fr 1fr;
        }

        .grid-cols-3 {
            grid-template-columns: repeat(3, 1fr);
        }

        @media (max-width: 768px) {
            .grid-cols-2, .grid-cols-3 {
                grid-template-columns: 1fr;
            }
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .form-group label {
            font-size: 14px;
            font-weight: 500;
            color: #374151;
        }

        .form-group input, .form-group textarea, .form-group select {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .form-group input:disabled, .form-group select:disabled {
            background-color: #f9fafb;
            color: #6b7280;
        }

        .input-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .input-label {
            width: 140px;
            font-size: 12px;
            font-weight: 500;
            color: #374151;
            flex-shrink: 0;
        }

        .input-field {
            flex: 1;
            padding: 6px 8px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 14px;
        }

        .input-unit {
            width: 32px;
            font-size: 12px;
            color: #6b7280;
            text-align: center;
            flex-shrink: 0;
        }

        .results {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 6px;
            margin-top: 16px;
        }

        .results h4 {
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
        }

        .result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 0;
            font-size: 12px;
        }

        .result-value {
            font-family: 'Courier New', monospace;
            font-weight: 500;
        }

        .critical-result {
            font-weight: bold;
            color: #dc2626;
        }

        .self-stress-results {
            background: #eff6ff;
        }

        .non-self-stress-results {
            background: #f0fdf4;
        }

        .calculator-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e5e7eb;
        }

        .self-stress-title {
            color: #1d4ed8;
            border-bottom-color: #1d4ed8;
        }

        .non-self-stress-title {
            color: #059669;
            border-bottom-color: #059669;
        }

        .acc-info {
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 16px;
        }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Embedded mode styles for ACC Custom Cards */
        .embedded-mode {
            background: white;
        }

        .embedded-mode .container {
            padding: 8px !important;
        }

        .embedded-mode .header {
            margin-bottom: 8px;
            padding: 12px;
        }

        .embedded-mode .card {
            margin-bottom: 8px;
            padding: 12px;
        }

        .embedded-mode .grid-cols-3 {
            grid-template-columns: 1fr 1fr;
        }

        .embedded-mode .acc-info {
            margin-bottom: 8px;
            padding: 8px;
        }

        #pdf-content {
            display: none;
        }

        @media print {
            body * { visibility: hidden; }
            #pdf-content, #pdf-content * { visibility: visible; }
            #pdf-content { position: absolute; top: 0; left: 0; width: 100%; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-left">
                <svg class="header-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 002 2z"></path>
                </svg>
                <div class="header-title">
                    <h1>PPPQC Stressing Calculator</h1>
                    <p>Autodesk Construction Cloud Integration</p>
                </div>
            </div>
            <div class="header-buttons">
                <span id="accStatus" class="status-badge status-disconnected">
                    <div class="loading"></div>
                    Connecting to ACC...
                </span>
                <button class="btn btn-save" id="saveBtn" onclick="saveToACC()" disabled>
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/>
                    </svg>
                    Save to ACC
                </button>
                <button class="btn btn-print" onclick="generatePDF()">
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M19 8H5c-1.66 0-3 1.34-3 3v6h4v4h12v-4h4v-6c0-1.66-1.34-3-3-3zm-3 11H8v-5h8v5zm3-7c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm-1-9H6v4h12V3z"/>
                    </svg>
                    Print Report
                </button>
                <button class="btn btn-export" id="exportBtn" onclick="exportToACCDocs()" disabled>
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
                    </svg>
                    Save to ACC Docs
                </button>
            </div>
        </div>

        <!-- ACC Integration Status -->
        <div class="acc-info" id="accInfo">
            <div id="accDetails">
                <div class="loading"></div>
                Initializing ACC Connection...
            </div>
        </div>

        <!-- Project Metadata -->
        <div class="card">
            <h3 class="card-title">
                <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
                </svg>
                Project Information
                <span id="projectSource" class="status-badge status-connected" style="margin-left: auto; display: none;">
                    Auto-populated from ACC
                </span>
            </h3>
            <div class="grid grid-cols-3">
                <div class="form-group">
                    <label for="projectName">Project Name</label>
                    <select id="projectName" onchange="onProjectSelected()" disabled>
                        <option value="">Loading projects from ACC...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="projectNumber">Project Number</label>
                    <input type="text" id="projectNumber" placeholder="Loading from ACC..." disabled>
                </div>
                <div class="form-group">
                    <label for="date">Date</label>
                    <input type="date" id="date">
                </div>
                <div class="form-group">
                    <label for="calculatedBy">Calculated By</label>
                    <input type="text" id="calculatedBy" placeholder="Loading from ACC..." disabled>
                </div>
                <div class="form-group">
                    <label for="reviewedBy">Reviewed By</label>
                    <input type="text" id="reviewedBy" placeholder="Reviewer name">
                </div>
                <div class="form-group">
                    <label for="location">Location</label>
                    <input type="text" id="location" placeholder="Loading from ACC..." disabled>
                </div>
            </div>
            <div class="form-group" style="margin-top: 12px;">
                <label for="notes">Notes</label>
                <textarea id="notes" rows="2" placeholder="Additional notes or comments"></textarea>
            </div>
        </div>

        <!-- Calculators Grid -->
        <div class="grid grid-cols-2">
            <!-- Self-Stressing Calculator -->
            <div class="card">
                <h2 class="calculator-title self-stress-title">Self-Stressing Bed Calculator</h2>
                
                <!-- Inputs -->
                <div id="selfStressInputs">
                    <div class="input-row">
                        <label class="input-label">Initial Pull:</label>
                        <input type="number" class="input-field" id="ss_initialPull" placeholder="0" oninput="calculateAll()">
                        <span class="input-unit">lbs</span>
                    </div>
                    <div class="input-row">
                        <label class="input-label">Required Force:</label>
                        <input type="number" class="input-field" id="ss_requiredForce" placeholder="0" oninput="calculateAll()">
                        <span class="input-unit">lbs</span>
                    </div>
                    <div class="input-row">
                        <label class="input-label">MOE:</label>
                        <input type="number" class="input-field" id="ss_MOE" placeholder="0" oninput="calculateAll()">
                        <span class="input-unit"></span>
                    </div>
                    <div class="input-row">
                        <label class="input-label"># of Strands:</label>
                        <input type="number" class="input-field" id="ss_numberOfStrands" placeholder="0" oninput="calculateAll()">
                        <span class="input-unit"></span>
                    </div>
                    <div class="input-row">
                        <label class="input-label">Adj Bed Short:</label>
                        <input type="number" class="input-field" id="ss_adjBedShortening" placeholder="0" oninput="calculateAll()">
                        <span class="input-unit">in</span>
                    </div>
                    <div class="input-row">
                        <label class="input-label">Block Length:</label>
                        <input type="number" class="input-field" id="ss_blockToBlockLength" placeholder="0" oninput="calculateAll()">
                        <span class="input-unit">ft</span>
                    </div>
                    <div class="input-row">
                        <label class="input-label">Strand Area:</label>
                        <input type="number" class="input-field" id="ss_strandArea" placeholder="0" oninput="calculateAll()">
                        <span class="input-unit">in²</span>
                    </div>
                    <div class="input-row">
                        <label class="input-label">Dead End Seat:</label>
                        <input type="number" class="input-field" id="ss_deadEndSeating" placeholder="0" oninput="calculateAll()">
                        <span class="input-unit">in</span>
                    </div>
                    <div class="input-row">
                        <label class="input-label">Live End Seat:</label>
                        <input type="number" class="input-field" id="ss_liveEndSeating" placeholder="0" oninput="calculateAll()">
                        <span class="input-unit">in</span>
                    </div>
                </div>

                <!-- Results -->
                <div class="results self-stress-results">
                    <h4>Results</h4>
                    <div class="result-item">
                        <span>Basic Elongation:</span>
                        <span class="result-value" id="ss_basicElongation">0.000 in</span>
                    </div>
                    <div class="result-item">
                        <span>Bed Shortening:</span>
                        <span class="result-value" id="ss_bedShortening">0.000 in</span>
                    </div>
                    <div class="result-item critical-result">
                        <span>Desired Elongation (Rounded):</span>
                        <span class="result-value" id="ss_desiredElongationRounded">0.000 in</span>
                    </div>
                    <div class="result-item critical-result">
                        <span>Calculated Pull (Rounded):</span>
                        <span class="result-value" id="ss_calculatedPullRounded">0 lbs</span>
                    </div>
                </div>
            </div>

            <!-- Non-Self-Stressing Calculator -->
            <div class="card">
                <h2 class="calculator-title non-self-stress-title">Non-Self-Stressing Bed Calculator</h2>
                
                <!-- Inputs -->
                <div id="nonSelfStressInputs">
                    <div class="input-row">
                        <label class="input-label">Initial Pull:</label>
                        <input type="number" class="input-field" id="nss_initialPull" placeholder="0" oninput="calculateAll()">
                        <span class="input-unit">lbs</span>
                    </div>
                    <div class="input-row">
                        <label class="input-label">Required Force:</label>
                        <input type="number" class="input-field" id="nss_requiredForce" placeholder="0" oninput="calculateAll()">
                        <span class="input-unit">lbs</span>
                    </div>
                    <div class="input-row">
                        <label class="input-label">MOE:</label>
                        <input type="number" class="input-field" id="nss_MOE" placeholder="0" oninput="calculateAll()">
                        <span class="input-unit"></span>
                    </div>
                    <div class="input-row">
                        <label class="input-label">Block Length:</label>
                        <input type="number" class="input-field" id="nss_blockToBlockLength" placeholder="0" oninput="calculateAll()">
                        <span class="input-unit">ft</span>
                    </div>
                    <div class="input-row">
                        <label class="input-label">Strand Area:</label>
                        <input type="number" class="input-field" id="nss_strandArea" placeholder="0" oninput="calculateAll()">
                        <span class="input-unit">in²</span>
                    </div>
                    <div class="input-row">
                        <label class="input-label">Air Temp:</label>
                        <input type="number" class="input-field" id="nss_airTemp" placeholder="0" oninput="calculateAll()">
                        <span class="input-unit">°F</span>
                    </div>
                    <div class="input-row">
                        <label class="input-label">Concrete Temp:</label>
                        <input type="number" class="input-field" id="nss_concreteTemp" placeholder="0" oninput="calculateAll()">
                        <span class="input-unit">°F</span>
                    </div>
                    <div class="input-row">
                        <label class="input-label">Dead End Seat:</label>
                        <input type="number" class="input-field" id="nss_deadEndSeating" placeholder="0" oninput="calculateAll()">
                        <span class="input-unit">in</span>
                    </div>
                    <div class="input-row">
                        <label class="input-label">Live End Seat:</label>
                        <input type="number" class="input-field" id="nss_liveEndSeating" placeholder="0" oninput="calculateAll()">
                        <span class="input-unit">in</span>
                    </div>
                    <div class="input-row">
                        <label class="input-label">Total Abutment:</label>
                        <input type="number" class="input-field" id="nss_totalAbutmentRotation" placeholder="0" oninput="calculateAll()">
                        <span class="input-unit">in</span>
                    </div>
                </div>

                <!-- Results -->
                <div class="results non-self-stress-results">
                    <h4>Results</h4>
                    <div class="result-item">
                        <span>Basic Elongation:</span>
                        <span class="result-value" id="nss_basicElongation">0.000 in</span>
                    </div>
                    <div class="result-item">
                        <span>Temp Difference:</span>
                        <span class="result-value" id="nss_tempDifference">0.000</span>
                    </div>
                    <div class="result-item">
                        <span>Temp Correction:</span>
                        <span class="result-value" id="nss_tempCorrection">0.000</span>
                    </div>
                    <div class="result-item critical-result">
                        <span>Desired Elongation (Rounded):</span>
                        <span class="result-value" id="nss_desiredElongationRounded">0.000 in</span>
                    </div>
                    <div class="result-item critical-result">
                        <span>Calculated Pull (Rounded):</span>
                        <span class="result-value" id="nss_calculatedPullRounded">0 lbs</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden PDF Content -->
    <div id="pdf-content">
        <div style="text-align: center; border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 20px;">
            <h1>PPPQC Stressing Calculation Report</h1>
            <p>Prestressed Concrete Stress Analysis</p>
        </div>
        
        <div id="printMetadata" style="background: #e5f3ff; padding: 10px; border-radius: 5px; margin-bottom: 20px;">
            <!-- Metadata will be inserted here -->
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div>
                <h3 style="color: #1d4ed8; margin-bottom: 10px;">Self-Stressing Bed Calculator</h3>
                <div id="printSelfStressInputs" style="margin-bottom: 15px;">
                    <!-- Self-stress inputs will be inserted here -->
                </div>
                <div id="printSelfStressResults" style="background: #f8f9fa; padding: 10px; border-radius: 5px;">
                    <!-- Self-stress results will be inserted here -->
                </div>
            </div>

            <div>
                <h3 style="color: #059669; margin-bottom: 10px;">Non-Self-Stressing Bed Calculator</h3>
                <div id="printNonSelfStressInputs" style="margin-bottom: 15px;">
                    <!-- Non-self-stress inputs will be inserted here -->
                </div>
                <div id="printNonSelfStressResults" style="background: #f8f9fa; padding: 10px; border-radius: 5px;">
                    <!-- Non-self-stress results will be inserted here -->
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // ========================================
        // ACC CONNECT CONFIGURATION
        // ========================================
        const ACC_CLIENT_ID = 'phUPKRBuqECpJUoBmRuKdKhSP3ZTRALH4LMWKAzAnymnYkQU';
        const ACC_CALLBACK_URL = 'https://metrocastpro.com/';
        const ACC_ENVIRONMENT = 'production';
        
        // ACC/Forge Integration Variables
        let forgeAccessToken = null;
        let projectId = null;
        let hubId = null;
        let userProfile = null;
        let isACCConnected = false;

        // Global calculation variables
        let currentCalculation = null;
        let userProjects = [];

        // Utility functions for iframe detection
        function isInIframe() {
            return window.self !== window.top;
        }

        // OAuth and Token Management - Made globally accessible
        window.showAuthButton = function() {
            updateConnectionStatus('disconnected', 'Click to Connect to ACC');
            document.getElementById('accStatus').innerHTML = `
                <button onclick="authenticateWithACC()" class="btn" style="background: #059669; color: white; border: none; padding: 4px 8px; border-radius: 4px;">
                    Connect to ACC
                </button>
            `;
        };

        window.authenticateWithACC = function() {
            const currentUrl = new URL(window.location.href);
            const callbackUrl = `${currentUrl.protocol}//${currentUrl.host}/`;
            
            const authUrl = `https://developer.api.autodesk.com/authentication/v2/authorize?` +
                `response_type=code&` +
                `client_id=${ACC_CLIENT_ID}&` +
                `redirect_uri=${encodeURIComponent(callbackUrl)}&` +
                `scope=${encodeURIComponent('data:read account:read')}&` +
                `state=pppqc-calc`;
            
            if (isInIframe()) {
                // If in iframe, open in new window/tab
                const authWindow = window.open(authUrl, 'acc_auth', 'width=600,height=700,scrollbars=yes,resizable=yes');
                
                // Listen for completion
                const checkClosed = setInterval(() => {
                    if (authWindow.closed) {
                        clearInterval(checkClosed);
                        // Check if we got a token
                        setTimeout(() => {
                            const storedToken = getStoredToken();
                            if (storedToken && !isTokenExpired(storedToken)) {
                                forgeAccessToken = storedToken.access_token;
                                loadRealProjectData();
                            } else {
                                // Reload to check for auth code in URL
                                window.location.reload();
                            }
                        }, 1000);
                    }
                }, 1000);
            } else {
                // Normal redirect flow
                console.log('Redirecting to auth URL:', authUrl);
                window.location.href = authUrl;
            }
        };

        async function handleAuthCode(code) {
            try {
                updateConnectionStatus('connected', 'Authenticating...');
                
                console.log('Authorization code received:', code);
                
                // Make sure we're using the correct callback URL
                const currentUrl = new URL(window.location.href);
                const callbackUrl = `${currentUrl.protocol}//${currentUrl.host}/`;
                
                console.log('Using callback URL:', callbackUrl);
                
                const tokenResponse = await fetch('/.netlify/functions/auth', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        code: code,
                        redirect_uri: callbackUrl
                    })
                });
                
                console.log('Token response status:', tokenResponse.status);
                
                const responseText = await tokenResponse.text();
                console.log('Token response text:', responseText);
                
                if (!tokenResponse.ok) {
                    throw new Error(`Token exchange failed: ${responseText}`);
                }
                
                let tokenData;
                try {
                    tokenData = JSON.parse(responseText);
                } catch (e) {
                    throw new Error(`Invalid JSON response: ${responseText}`);
                }
                
                if (tokenData.error) {
                    throw new Error(`Auth error: ${tokenData.error} - ${tokenData.error_description || ''}`);
                }
                
                if (!tokenData.access_token) {
                    throw new Error('No access token received');
                }
                
                forgeAccessToken = tokenData.access_token;
                console.log('Access token received successfully');
                
                storeToken(tokenData);
                await loadRealProjectData();
                
                // Clean up URL
                window.history.replaceState({}, document.title, window.location.pathname);
                
            } catch (error) {
                console.error('Authentication failed:', error);
                handleACCConnectionError(error);
            }
        }

        function storeToken(tokenData) {
            const expirationTime = Date.now() + (tokenData.expires_in * 1000);
            const tokenInfo = {
                access_token: tokenData.access_token,
                expires_at: expirationTime
            };
            sessionStorage.setItem('forge_token', JSON.stringify(tokenInfo));
        }

        function getStoredToken() {
            const stored = sessionStorage.getItem('forge_token');
            return stored ? JSON.parse(stored) : null;
        }

        function isTokenExpired(tokenInfo) {
            return Date.now() >= tokenInfo.expires_at;
        }

        async function loadRealProjectData() {
            try {
                updateConnectionStatus('connected', 'Loading Projects...');
                
                console.log('Starting to load real project data...');
                
                // Get user's hubs
                console.log('Fetching user hubs...');
                const hubsResponse = await fetch('https://developer.api.autodesk.com/project/v1/hubs', {
                    headers: {
                        'Authorization': `Bearer ${forgeAccessToken}`
                    }
                });
                
                if (!hubsResponse.ok) {
                    const errorText = await hubsResponse.text();
                    console.error('Hubs response error:', hubsResponse.status, errorText);
                    throw new Error(`Failed to load hubs: ${hubsResponse.status} ${errorText}`);
                }
                
                const hubsData = await hubsResponse.json();
                console.log('Hubs data received:', hubsData);
                
                // Find ACC/BIM360 hubs specifically (not Fusion hubs)
                const accHubs = hubsData.data.filter(hub => 
                    hub.attributes.extension?.type === 'hubs:autodesk.bim360:Account'
                );
                
                console.log('ACC hubs found:', accHubs.length);
                
                if (accHubs.length > 0) {
                    const firstAccHub = accHubs[0];
                    console.log('Using ACC hub:', firstAccHub.attributes.name, firstAccHub.id);
                    
                    await loadProjectsFromHub(firstAccHub.id);
                } else {
                    console.warn('No ACC hubs found in response');
                    throw new Error('No ACC hubs found - only Fusion 360 hubs available');
                }
                
                console.log('Project data loading completed successfully');
                updateConnectionStatus('connected', 'Connected to ACC');
                isACCConnected = true;
                enableACCFeatures();
                
            } catch (error) {
                console.error('Failed to load project data:', error);
                
                // Show error but still enable features for manual entry
                updateConnectionStatus('connected', 'Connected (Manual Entry Mode)');
                isACCConnected = true;
                enableACCFeatures();
                
                // Enable manual project entry
                document.getElementById('accDetails').innerHTML = `
                    <div style="color: #dc2626;">
                        <strong>Project Loading Issue:</strong> ${error.message}<br>
                        <small>You can still use the calculator by entering project details manually</small>
                    </div>
                `;
                
                // Setup for manual entry
                const projectSelect = document.getElementById('projectName');
                projectSelect.innerHTML = '<option value="">Enter project details manually below...</option>';
                projectSelect.disabled = false;
                
                // Enable all manual input fields
                ['projectNumber', 'calculatedBy', 'location'].forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.disabled = false;
                        element.placeholder = element.placeholder.replace('Loading from ACC...', 'Enter manually');
                    }
                });
            }
        }

        async function loadProjectsFromHub(hubId) {
            try {
                console.log('Loading projects from ACC hub:', hubId);
                
                const projectsResponse = await fetch(`https://developer.api.autodesk.com/project/v1/hubs/${hubId}/projects`, {
                    headers: {
                        'Authorization': `Bearer ${forgeAccessToken}`
                    }
                });
                
                if (!projectsResponse.ok) {
                    throw new Error('Failed to load projects');
                }
                
                const projectsData = await projectsResponse.json();
                console.log('ACC projects data received:', projectsData);
                
                // Convert to our format with enhanced project metadata extraction
                const projects = projectsData.data.map(project => {
                    console.log('Processing ACC project:', project.attributes.name);
                    
                    // Extract project number from various possible locations
                    let projectNumber = '';
                    
                    // Try different places where project number might be stored
                    if (project.attributes.extension?.data) {
                        const extData = project.attributes.extension.data;
                        projectNumber = extData.projectNumber || 
                                      extData.project_number || 
                                      extData.number || 
                                      extData.projectId ||
                                      extData.project_id || '';
                    }
                    
                    // If no project number found, generate one from project name or ID
                    if (!projectNumber) {
                        // Try to extract from project name (common patterns like "Project ABC-123")
                        const nameMatch = project.attributes.name.match(/([A-Z]{2,}-\d+|\d{4}-\d+|[A-Z]+\d+)/);
                        if (nameMatch) {
                            projectNumber = nameMatch[0];
                        } else {
                            // Use last 6 characters of project ID as fallback
                            projectNumber = `ACC-${project.id.slice(-6)}`;
                        }
                    }
                    
                    return {
                        id: project.id,
                        name: project.attributes.name || 'Unnamed Project',
                        number: projectNumber,
                        location: project.attributes.extension?.data?.location || 
                                 project.attributes.extension?.data?.project_location || 
                                 'Location not specified',
                        // Store full project data for additional metadata
                        fullData: project
                    };
                });
                
                console.log('Processed ACC projects:', projects);
                
                populateProjectDropdown(projects);
                
                // Auto-select first project if available
                if (projects.length > 0) {
                    setTimeout(() => {
                        const projectSelect = document.getElementById('projectName');
                        projectSelect.value = projects[0].id;
                        onProjectSelected();
                    }, 100);
                }
                
            } catch (error) {
                console.error('Error in loadProjectsFromHub:', error);
                throw error;
            }
        }

        function populateProjectDropdown(projects) {
            try {
                console.log('Populating dropdown with ACC projects:', projects);
                
                userProjects = projects;
                const projectSelect = document.getElementById('projectName');
                
                if (!projectSelect) {
                    console.error('Project select element not found');
                    return;
                }
                
                // Clear existing options
                projectSelect.innerHTML = '<option value="">Select an ACC project...</option>';
                
                // Add projects to dropdown
                projects.forEach((project, index) => {
                    console.log(`Adding ACC project ${index + 1}:`, project.name, 'Number:', project.number);
                    
                    const option = document.createElement('option');
                    option.value = project.id;
                    option.textContent = `${project.name} (${project.number})`;
                    option.dataset.projectNumber = project.number || '';
                    option.dataset.location = project.location || '';
                    projectSelect.appendChild(option);
                });
                
                // Enable the dropdown
                projectSelect.disabled = false;
                projectSelect.style.backgroundColor = '';
                
                console.log('ACC project dropdown populated successfully');
                
                // Update status to show connection is complete
                updateConnectionStatus('connected', 'ACC Projects Loaded');
                
                // Stop any loading spinners
                document.getElementById('accDetails').innerHTML = `
                    <strong>Status:</strong> Connected to ACC<br>
                    <strong>Projects Found:</strong> ${projects.length} ACC projects<br>
                    <strong>Hub:</strong> Metromont ACC Account
                `;
                
            } catch (error) {
                console.error('Error in populateProjectDropdown:', error);
                throw error;
            }
        }

        function onProjectSelected() {
            const projectSelect = document.getElementById('projectName');
            const selectedOption = projectSelect.selectedOptions[0];
            
            if (selectedOption && selectedOption.value) {
                // Auto-populate related fields from ACC project data
                const projectNumber = selectedOption.dataset.projectNumber || '';
                const location = selectedOption.dataset.location || '';
                
                console.log('Selected ACC project:', selectedOption.textContent);
                console.log('Project number:', projectNumber);
                console.log('Location:', location);
                
                document.getElementById('projectNumber').value = projectNumber;
                document.getElementById('location').value = location;
                
                // Enable other fields
                document.getElementById('projectNumber').disabled = false;
                document.getElementById('location').disabled = false;
                document.getElementById('calculatedBy').disabled = false;
                
                // Update project source indicator
                document.getElementById('projectSource').style.display = 'inline-flex';
                document.getElementById('projectSource').textContent = 'Selected from ACC';
                
                // Set calculated by field to current user if available
                if (!document.getElementById('calculatedBy').value) {
                    // Could extract user info from token or set a default
                    document.getElementById('calculatedBy').value = 'ACC User';
                }
            }
        }

        // Initialize ACC Connection
        document.addEventListener('DOMContentLoaded', function() {
            // Detect if we're running in an iframe (ACC Custom Card)
            if (window.self !== window.top) {
                document.body.classList.add('embedded-mode');
                // Adjust layout for embedded context
                document.querySelector('.container').style.maxWidth = '100%';
                document.querySelector('.container').style.padding = '8px';
            }
            
            initializeACCConnection();
            setupUI();
            calculateAll();
        });

        // ACC/Forge Authentication and Setup
        async function initializeACCConnection() {
            try {
                // Check if we have an authorization code from ACC
                const urlParams = new URLSearchParams(window.location.search);
                const authCode = urlParams.get('code');
                const state = urlParams.get('state');
                const error = urlParams.get('error');
                
                // Handle OAuth errors
                if (error) {
                    throw new Error(`OAuth error: ${error} - ${urlParams.get('error_description') || ''}`);
                }
                
                if (authCode) {
                    // Verify state parameter for security
                    if (state !== 'pppqc-calc') {
                        console.warn('State parameter mismatch');
                    }
                    await handleAuthCode(authCode);
                } else {
                    // Check if we have a stored token
                    const storedToken = getStoredToken();
                    if (storedToken && !isTokenExpired(storedToken)) {
                        forgeAccessToken = storedToken.access_token;
                        console.log('Using stored token');
                        await loadRealProjectData();
                    } else {
                        // Need to authenticate
                        console.log('No valid token found, showing auth button');
                        showAuthButton();
                    }
                }
            } catch (error) {
                console.error('Connection Error:', error);
                handleACCConnectionError(error);
            }
        }

        function simulateACCEnvironment() {
            // Immediate connection in simulation mode
            updateConnectionStatus('connected', 'Simulation Mode - Ready to Use');
            
            // Enable all fields for manual entry
            ['projectNumber', 'calculatedBy', 'location'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.disabled = false;
                    if (element.placeholder && element.placeholder.includes('Loading from ACC...')) {
                        element.placeholder = element.placeholder.replace('Loading from ACC...', 'Enter or select');
                    }
                }
            });
            
            // Handle dropdown separately
            const projectSelect = document.getElementById('projectName');
            projectSelect.disabled = false;
            projectSelect.innerHTML = '<option value="">Enter project name manually below...</option>';
            
            // Show that it's simulation mode
            document.getElementById('accDetails').innerHTML = `
                <strong>Mode:</strong> Simulation Mode<br>
                <strong>Features:</strong> All calculations working, manual project entry<br>
                <strong>Status:</strong> Ready for use
            `;
            
            enableACCFeatures();
        }

        function updateConnectionStatus(status, message) {
            const statusElement = document.getElementById('accStatus');
            const accInfo = document.getElementById('accInfo');
            
            if (status === 'connected') {
                statusElement.className = 'status-badge status-connected';
                statusElement.innerHTML = `
                    <svg width="12" height="12" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                    </svg>
                    ${message}
                `;
                isACCConnected = true;
                accInfo.style.borderColor = '#10b981';
                accInfo.style.backgroundColor = '#ecfdf5';
            } else {
                statusElement.className = 'status-badge status-disconnected';
                statusElement.innerHTML = `
                    <svg width="12" height="12" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                    </svg>
                    ${message}
                `;
                isACCConnected = false;
            }
        }

        function enableACCFeatures() {
            // Enable ACC-specific buttons
            document.getElementById('saveBtn').disabled = false;
            document.getElementById('exportBtn').disabled = false;
        }

        function handleACCConnectionError(error) {
            updateConnectionStatus('disconnected', 'Connection Failed');
            console.error('Full error details:', error);
            
            // Show user-friendly error message
            let errorMessage = 'Connection failed';
            if (error.message.includes('Token exchange failed')) {
                errorMessage = 'Authentication failed - please check app configuration';
            } else if (error.message.includes('OAuth error')) {
                errorMessage = error.message;
            }
            
            document.getElementById('accDetails').innerHTML = `
                <div style="color: #dc2626;">
                    <strong>Error:</strong> ${errorMessage}<br>
                    <small>${error.message}</small><br>
                    <button onclick="showAuthButton(); location.reload();" style="margin-top: 8px; padding: 4px 8px; background: #059669; color: white; border: none; border-radius: 4px;">
                        Try Again
                    </button>
                </div>
                <div style="margin-top: 8px; color: #6b7280;">
                    <em>Calculator will work in offline mode</em>
                </div>
            `;
            
            // Enable manual input mode
            simulateACCEnvironment();
        }

        function setupUI() {
            // Set current date
            document.getElementById('date').value = new Date().toISOString().split('T')[0];
        }

        // Post-message handler for iframe authentication
        window.addEventListener('message', function(event) {
            if (event.origin !== window.location.origin) return;
            
            if (event.data.type === 'ACC_AUTH_SUCCESS' && event.data.token) {
                forgeAccessToken = event.data.token;
                storeToken({ access_token: event.data.token, expires_in: 3600 });
                loadRealProjectData();
                updateConnectionStatus('connected', 'Connected to ACC');
            }
        });

        // Utility functions
        function formatNumber(num) {
            if (isNaN(num) || !isFinite(num)) return '0.000';
            return num.toFixed(3);
        }

        function formatInteger(num) {
            if (isNaN(num) || !isFinite(num)) return '0';
            return Math.round(num).toString();
        }

        function getValue(id) {
            return parseFloat(document.getElementById(id).value) || 0;
        }

        // Calculation functions
        function calculateSelfStressing() {
            const ip = getValue('ss_initialPull');
            const rf = getValue('ss_requiredForce');
            const moe = getValue('ss_MOE') || 1;
            const ns = getValue('ss_numberOfStrands') || 1;
            const abs = getValue('ss_adjBedShortening');
            const btbl = getValue('ss_blockToBlockLength');
            const sa = getValue('ss_strandArea') || 1;
            const des = getValue('ss_deadEndSeating');
            const les = getValue('ss_liveEndSeating');

            const basicElongation = ((rf - ip) * btbl * 12) / (sa * moe);
            const bedShortening = (abs / 2) + (abs / ns);
            const desiredElongation = basicElongation + des + bedShortening;
            const desiredElongationRounded = Math.ceil(Math.round(desiredElongation * 1000) / 1000 * 8) / 8;
            const LESeatingAdd = basicElongation !== 0 ? (les / basicElongation) * (rf - ip) : 0;
            const bedShorteningAdd = basicElongation !== 0 ? (bedShortening / basicElongation) * (rf - ip) : 0;
            const desiredPull = rf + LESeatingAdd + bedShorteningAdd;
            const calculatedPullRounded = Math.ceil(Math.round(desiredPull) / 100) * 100;

            // Update display
            document.getElementById('ss_basicElongation').textContent = formatNumber(basicElongation) + ' in';
            document.getElementById('ss_bedShortening').textContent = formatNumber(bedShortening) + ' in';
            document.getElementById('ss_desiredElongationRounded').textContent = formatNumber(desiredElongationRounded) + ' in';
            document.getElementById('ss_calculatedPullRounded').textContent = formatInteger(calculatedPullRounded) + ' lbs';

            return {
                basicElongation, bedShortening, desiredElongation, desiredElongationRounded,
                LESeatingAdd, bedShorteningAdd, desiredPull, calculatedPullRounded
            };
        }

        function calculateNonSelfStressing() {
            const ip = getValue('nss_initialPull');
            const rf = getValue('nss_requiredForce');
            const moe = getValue('nss_MOE') || 1;
            const btbl = getValue('nss_blockToBlockLength');
            const sa = getValue('nss_strandArea') || 1;
            const at = getValue('nss_airTemp');
            const ct = getValue('nss_concreteTemp');
            const des = getValue('nss_deadEndSeating');
            const les = getValue('nss_liveEndSeating');
            const tar = getValue('nss_totalAbutmentRotation');

            const basicElongation = ((rf - ip) * btbl * 12) / (sa * moe);
            const tempDifference = (ct - at) / 1000;
            const tca2 = ((rf - ip) * btbl * 12) / (sa - moe) * tempDifference;
            const tcPart1 = tempDifference > 0.024 ? tca2 : 0;
            const tcPart2 = tempDifference < -0.024 ? basicElongation * tempDifference : 0;
            const tempCorrection = tcPart1 + tcPart2;
            const desiredElongation = basicElongation + des + tempCorrection;
            const desiredElongationRounded = Math.ceil(Math.round(desiredElongation * 1000) / 1000 * 8) / 8;
            const LESeatingAdd = basicElongation !== 0 ? (les / basicElongation) * (rf - ip) : 0;
            const tca1 = (rf + les + tar) * tempDifference;
            const tcPart1Pull = tempDifference > 0.024 ? tca1 : 0;
            const tcPart2Pull = tempDifference < -0.024 ? tca1 : 0;
            const tempCorrectionPull = tcPart1Pull + tcPart2Pull;
            const desiredPull = rf + LESeatingAdd + tempCorrectionPull;
            const calculatedPullRounded = Math.ceil(Math.round(desiredPull) / 100) * 100;

            // Update display
            document.getElementById('nss_basicElongation').textContent = formatNumber(basicElongation) + ' in';
            document.getElementById('nss_tempDifference').textContent = formatNumber(tempDifference);
            document.getElementById('nss_tempCorrection').textContent = formatNumber(tempCorrection);
            document.getElementById('nss_desiredElongationRounded').textContent = formatNumber(desiredElongationRounded) + ' in';
            document.getElementById('nss_calculatedPullRounded').textContent = formatInteger(calculatedPullRounded) + ' lbs';

            return {
                basicElongation, tempDifference, tca2, tcPart1, tcPart2, tempCorrection,
                desiredElongation, desiredElongationRounded, LESeatingAdd, tca1,
                tcPart1Pull, tcPart2Pull, tempCorrectionPull, desiredPull, calculatedPullRounded
            };
        }

        function calculateAll() {
            const selfStressingResults = calculateSelfStressing();
            const nonSelfStressingResults = calculateNonSelfStressing();
            
            // Store current calculation
            currentCalculation = {
                timestamp: new Date().toISOString(),
                projectMetadata: {
                    projectName: document.getElementById('projectName').value,
                    projectNumber: document.getElementById('projectNumber').value,
                    date: document.getElementById('date').value,
                    calculatedBy: document.getElementById('calculatedBy').value,
                    reviewedBy: document.getElementById('reviewedBy').value,
                    location: document.getElementById('location').value,
                    notes: document.getElementById('notes').value
                },
                selfStressing: {
                    inputs: {
                        initialPull: getValue('ss_initialPull'),
                        requiredForce: getValue('ss_requiredForce'),
                        MOE: getValue('ss_MOE'),
                        numberOfStrands: getValue('ss_numberOfStrands'),
                        adjBedShortening: getValue('ss_adjBedShortening'),
                        blockToBlockLength: getValue('ss_blockToBlockLength'),
                        strandArea: getValue('ss_strandArea'),
                        deadEndSeating: getValue('ss_deadEndSeating'),
                        liveEndSeating: getValue('ss_liveEndSeating')
                    },
                    outputs: selfStressingResults
                },
                nonSelfStressing: {
                    inputs: {
                        initialPull: getValue('nss_initialPull'),
                        requiredForce: getValue('nss_requiredForce'),
                        MOE: getValue('nss_MOE'),
                        blockToBlockLength: getValue('nss_blockToBlockLength'),
                        strandArea: getValue('nss_strandArea'),
                        airTemp: getValue('nss_airTemp'),
                        concreteTemp: getValue('nss_concreteTemp'),
                        deadEndSeating: getValue('nss_deadEndSeating'),
                        liveEndSeating: getValue('nss_liveEndSeating'),
                        totalAbutmentRotation: getValue('nss_totalAbutmentRotation')
                    },
                    outputs: nonSelfStressingResults
                }
            };
        }

        // ACC Integration Functions
        async function saveToACC() {
            if (!isACCConnected) {
                alert('Not connected to ACC. Please check your connection.');
                return;
            }

            try {
                // In real implementation, this would call Forge Data Management API
                // For now, simulate saving to ACC
                const saveBtn = document.getElementById('saveBtn');
                saveBtn.disabled = true;
                saveBtn.innerHTML = '<div class="loading"></div> Saving...';

                // Simulate API call
                await new Promise(resolve => setTimeout(resolve, 1500));

                // Simulate successful save
                console.log('Saved to ACC:', currentCalculation);
                
                saveBtn.disabled = false;
                saveBtn.innerHTML = `
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/>
                    </svg>
                    Save to ACC
                `;
                
                alert('Calculation saved to ACC successfully!');
            } catch (error) {
                console.error('Save to ACC failed:', error);
                alert('Failed to save to ACC: ' + error.message);
                
                saveBtn.disabled = false;
                saveBtn.innerHTML = `
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/>
                    </svg>
                    Save to ACC
                `;
            }
        }

        async function exportToACCDocs() {
            if (!isACCConnected) {
                alert('Not connected to ACC. Please check your connection.');
                return;
            }

            try {
                const exportBtn = document.getElementById('exportBtn');
                exportBtn.disabled = true;
                exportBtn.innerHTML = '<div class="loading"></div> Exporting...';

                // Generate the report data
                generatePDFData();

                // In real implementation, this would upload to ACC Document Management
                // For now, simulate the export
                await new Promise(resolve => setTimeout(resolve, 2000));

                exportBtn.disabled = false;
                exportBtn.innerHTML = `
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
                    </svg>
                    Save to ACC Docs
                `;

                alert('Report exported to ACC Documents successfully!');
            } catch (error) {
                console.error('Export to ACC failed:', error);
                alert('Failed to export to ACC: ' + error.message);
            }
        }

        function generatePDF() {
            generatePDFData();
            window.print();
        }

        function generatePDFData() {
            const metadata = currentCalculation.projectMetadata;
            const selfStressingResults = currentCalculation.selfStressing.outputs;
            const nonSelfStressingResults = currentCalculation.nonSelfStressing.outputs;

            // Update print content
            document.getElementById('printMetadata').innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                    <div><strong>Project:</strong> ${metadata.projectName}</div>
                    <div><strong>Project #:</strong> ${metadata.projectNumber}</div>
                    <div><strong>Date:</strong> ${metadata.date}</div>
                    <div><strong>Calculated By:</strong> ${metadata.calculatedBy}</div>
                    <div><strong>Reviewed By:</strong> ${metadata.reviewedBy}</div>
                    <div><strong>Location:</strong> ${metadata.location}</div>
                </div>
                ${metadata.notes ? `<div><strong>Notes:</strong> ${metadata.notes}</div>` : ''}
            `;

            // Generate detailed input and result summaries for printing
            document.getElementById('printSelfStressInputs').innerHTML = `
                <h4>Input Values:</h4>
                <div><strong>Initial Pull:</strong> ${currentCalculation.selfStressing.inputs.initialPull} lbs</div>
                <div><strong>Required Force:</strong> ${currentCalculation.selfStressing.inputs.requiredForce} lbs</div>
                <div><strong>MOE:</strong> ${currentCalculation.selfStressing.inputs.MOE}</div>
                <div><strong># of Strands:</strong> ${currentCalculation.selfStressing.inputs.numberOfStrands}</div>
                <div><strong>Adjusted Bed Shortening:</strong> ${currentCalculation.selfStressing.inputs.adjBedShortening} inches</div>
                <div><strong>Block-to-Block Length:</strong> ${currentCalculation.selfStressing.inputs.blockToBlockLength} feet</div>
                <div><strong>Strand Area:</strong> ${currentCalculation.selfStressing.inputs.strandArea} sq inches</div>
                <div><strong>Dead-End Seating:</strong> ${currentCalculation.selfStressing.inputs.deadEndSeating} inches</div>
                <div><strong>Live End Seating:</strong> ${currentCalculation.selfStressing.inputs.liveEndSeating} inches</div>
            `;

            document.getElementById('printSelfStressResults').innerHTML = `
                <h4>Calculated Results:</h4>
                <div style="display: flex; justify-content: space-between;"><span>Basic Elongation:</span><span>${formatNumber(selfStressingResults.basicElongation)} inches</span></div>
                <div style="display: flex; justify-content: space-between;"><span>Bed Shortening:</span><span>${formatNumber(selfStressingResults.bedShortening)} inches</span></div>
                <div style="display: flex; justify-content: space-between; font-weight: bold; color: #dc2626;"><span>Desired Elongation (Rounded):</span><span>${formatNumber(selfStressingResults.desiredElongationRounded)} inches</span></div>
                <div style="display: flex; justify-content: space-between; font-weight: bold; color: #dc2626;"><span>Calculated Pull (Rounded):</span><span>${formatInteger(selfStressingResults.calculatedPullRounded)} lbs</span></div>
            `;

            document.getElementById('printNonSelfStressInputs').innerHTML = `
                <h4>Input Values:</h4>
                <div><strong>Initial Pull:</strong> ${currentCalculation.nonSelfStressing.inputs.initialPull} lbs</div>
                <div><strong>Required Force:</strong> ${currentCalculation.nonSelfStressing.inputs.requiredForce} lbs</div>
                <div><strong>MOE:</strong> ${currentCalculation.nonSelfStressing.inputs.MOE}</div>
                <div><strong>Block-to-Block Length:</strong> ${currentCalculation.nonSelfStressing.inputs.blockToBlockLength} feet</div>
                <div><strong>Strand Area:</strong> ${currentCalculation.nonSelfStressing.inputs.strandArea} sq inches</div>
                <div><strong>Air Temperature:</strong> ${currentCalculation.nonSelfStressing.inputs.airTemp} °F</div>
                <div><strong>Concrete Temperature:</strong> ${currentCalculation.nonSelfStressing.inputs.concreteTemp} °F</div>
                <div><strong>Dead-End Seating:</strong> ${currentCalculation.nonSelfStressing.inputs.deadEndSeating} inches</div>
                <div><strong>Live End Seating:</strong> ${currentCalculation.nonSelfStressing.inputs.liveEndSeating} inches</div>
                <div><strong>Total Abutment Rotation:</strong> ${currentCalculation.nonSelfStressing.inputs.totalAbutmentRotation} inches</div>
            `;

            document.getElementById('printNonSelfStressResults').innerHTML = `
                <h4>Calculated Results:</h4>
                <div style="display: flex; justify-content: space-between;"><span>Basic Elongation:</span><span>${formatNumber(nonSelfStressingResults.basicElongation)} inches</span></div>
                <div style="display: flex; justify-content: space-between;"><span>Temperature Difference:</span><span>${formatNumber(nonSelfStressingResults.tempDifference)}</span></div>
                <div style="display: flex; justify-content: space-between;"><span>Temperature Correction:</span><span>${formatNumber(nonSelfStressingResults.tempCorrection)}</span></div>
                <div style="display: flex; justify-content: space-between; font-weight: bold; color: #dc2626;"><span>Desired Elongation (Rounded):</span><span>${formatNumber(nonSelfStressingResults.desiredElongationRounded)} inches</span></div>
                <div style="display: flex; justify-content: space-between; font-weight: bold; color: #dc2626;"><span>Calculated Pull (Rounded):</span><span>${formatInteger(nonSelfStressingResults.calculatedPullRounded)} lbs</span></div>
            `;
        }
    </script>
</body>
</html>
                
