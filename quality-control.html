<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="frame-ancestors 'self' https://*.autodesk.com https://*.autodeskbim360.com https://*.acc.autodesk.com;">
    <title>Quality Control - Bed QC Report | Metromont CastLink</title>
    <link rel="stylesheet" href="styles/quality-control.css">
</head>
<body class="auth-loading">
    <!-- Auth Processing Overlay -->
    <div class="auth-processing active" id="authProcessing">
        <div class="auth-processing-content">
            <div class="loading"></div>
            <h3 id="authTitle">Verifying Authentication</h3>
            <p id="authMessage">Checking your Autodesk Construction Cloud connection...</p>
        </div>
    </div>
    <header class="header">
        <div class="header-content">
            <div class="logo-section">
                <img src="assets/images/metromont-logo.png" alt="Metromont Logo" class="logo" />
                <div class="brand-text">
                    <h1>Quality Control</h1>
                    <p>Manufacturing Quality Assurance</p>
                </div>
            </div>
            <div class="nav-breadcrumb">
                <a href="index.html">Dashboard</a>
                <span>→</span>
                <span>Quality Control</span>
            </div>
            <div class="header-buttons">
                <button class="btn btn-back" onclick="window.location.href='index.html'">
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z" />
                    </svg>
                    Back to Dashboard
                </button>
                <div class="status-badge status-connected" id="authStatusBadge" style="display: none;">
                    <svg width="12" height="12" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z" />
                    </svg>
                    Connected to ACC
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="page-header">
            <div class="page-title">
                <svg width="32" height="32" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <h2>Quality Control Center</h2>
            </div>
            <p style="color: #64748b; font-size: 1rem;">Comprehensive quality assurance tools for precast concrete manufacturing operations.</p>
        </div>

        <!-- ACC Integration Status -->
        <div class="acc-info" id="accInfo">
            <div id="accDetails">
                <strong>Status:</strong> Connected to ACC<br>
                <strong>Authentication:</strong> Automatically verified<br>
                <strong>Hub:</strong> Metromont ACC Account
            </div>
        </div>

        <!-- Quality Control Tools -->
        <div class="tools-grid">
            <div class="tool-card" onclick="showBedSelection()">
                <div class="tool-icon">
                    <svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 002 2z" />
                    </svg>
                </div>
                <h3 class="tool-title">New Bed Report</h3>
                <p class="tool-description">Generate Bed QC reports and quality calculations for precast concrete bed operations.</p>
                <div class="tool-status">
                    <span class="status-badge status-active">Active</span>
                    <span style="margin-left: auto; color: #64748b;">Bed QC Calculator</span>
                </div>
            </div>

            <div class="tool-card" style="opacity: 0.6; cursor: not-allowed;">
                <div class="tool-icon">
                    <svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
                    </svg>
                </div>
                <h3 class="tool-title">Quality Inspection</h3>
                <p class="tool-description">Conduct comprehensive quality inspections with digital checklists and documentation.</p>
                <div class="tool-status">
                    <span class="status-badge status-development">In Development</span>
                    <span style="margin-left: auto; color: #64748b;">Q1 2025</span>
                </div>
            </div>

            <div class="tool-card" style="opacity: 0.6; cursor: not-allowed;">
                <div class="tool-icon">
                    <svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M16 4v12l-4-2-4 2V4M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                </div>
                <h3 class="tool-title">Compliance Tracking</h3>
                <p class="tool-description">Monitor regulatory compliance, certifications, and quality standards adherence.</p>
                <div class="tool-status">
                    <span class="status-badge status-development">In Development</span>
                    <span style="margin-left: auto; color: #64748b;">Q2 2025</span>
                </div>
            </div>

            <div class="tool-card" style="opacity: 0.6; cursor: not-allowed;">
                <div class="tool-icon">
                    <svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z" />
                    </svg>
                </div>
                <h3 class="tool-title">Quality Analytics</h3>
                <p class="tool-description">Advanced analytics and reporting for quality trends, defect analysis, and process optimization.</p>
                <div class="tool-status">
                    <span class="status-badge status-development">In Development</span>
                    <span style="margin-left: auto; color: #64748b;">Q3 2025</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Bed Selection Modal -->
    <div class="modal-overlay" id="bedSelectionModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Select Production Bed</h3>
                <button class="modal-close" onclick="closeBedSelection()">&times;</button>
            </div>
            <div class="modal-content">
                <div class="form-group">
                    <label for="bedSelect">Choose the production bed for this report:</label>
                    <select id="bedSelect">
                        <option value="">Select a bed...</option>
                        <option value="beam">Beam</option>
                        <option value="deck1">Deck 1</option>
                        <option value="deck2">Deck 2</option>
                        <option value="flatbed1">Flat Bed #1</option>
                        <option value="flatbed2">Flat Bed #2</option>
                        <option value="flatbed3">Flat Bed #3</option>
                        <option value="flatbed4">Flat Bed #4</option>
                        <option value="flatbed5">Flat Bed #5</option>
                        <option value="flatbed6">Flat Bed #6</option>
                        <option value="flatbed7">Flat Bed #7</option>
                        <option value="pcbed1">PC Bed #1</option>
                        <option value="pcbed2">PC Bed #2</option>
                        <option value="pcbed3">PC Bed #3</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="reportDescription">Report Description (Optional):</label>
                    <input type="text" id="reportDescription" placeholder="e.g., Morning shift quality check">
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeBedSelection()">Cancel</button>
                <button class="btn btn-primary" onclick="startBedReport()">Start Report</button>
            </div>
        </div>
    </div>

    <!-- Calculator Modal -->
    <div class="modal-overlay" id="calculatorModal">
        <div class="modal calculator-modal">
            <div class="modal-header">
                <div>
                    <h3 class="modal-title">Bed QC Report</h3>
                    <div class="report-header">
                        <div class="bed-info">
                            <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z" />
                            </svg>
                            <span id="selectedBedDisplay">No bed selected</span>
                        </div>
                        <div class="report-id">Report ID: <span id="reportId">-</span></div>
                    </div>
                </div>
                <div style="display: flex; gap: 0.5rem; align-items: center;">
                    <button class="btn btn-save" id="saveBtn" onclick="saveToACC()" disabled>
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z" />
                        </svg>
                        Save Report
                    </button>
                    <button class="btn btn-print" onclick="generatePDF()">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M19 8H5c-1.66 0-3 1.34-3 3v6h4v4h12v-4h4v-6c0-1.66-1.34-3-3-3zm-3 11H8v-5h8v5zm3-7c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm-1-9H6v4h12V3z" />
                        </svg>
                        Print Report
                    </button>
                    <button class="btn btn-export" id="exportBtn" onclick="exportToACCDocs()" disabled>
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z" />
                        </svg>
                        Export Report
                    </button>
                    <button class="modal-close" onclick="closeCalculator()">&times;</button>
                </div>
            </div>

            <!-- Project Metadata -->
            <div class="card">
                <h3 class="card-title">
                    <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z" />
                    </svg>
                    Project Information
                    <span id="projectSource" class="status-badge status-connected" style="margin-left: auto; display: none;">
                        Auto-populated from ACC
                    </span>
                </h3>
                <div class="grid grid-cols-3">
                    <div class="form-group">
                        <label for="projectName">Project Name</label>
                        <select id="projectName" onchange="onProjectSelected()" disabled>
                            <option value="">Loading projects from ACC...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="projectNumber">Project Number</label>
                        <input type="text" id="projectNumber" placeholder="Loading from ACC..." disabled>
                    </div>
                    <div class="form-group">
                        <label for="date">Date</label>
                        <input type="date" id="date">
                    </div>
                    <div class="form-group">
                        <label for="calculatedBy">Calculated By</label>
                        <input type="text" id="calculatedBy" placeholder="Loading from ACC..." disabled>
                    </div>
                    <div class="form-group">
                        <label for="reviewedBy">Reviewed By</label>
                        <input type="text" id="reviewedBy" placeholder="Reviewer name">
                    </div>
                    <div class="form-group">
                        <label for="location">Location</label>
                        <input type="text" id="location" placeholder="Loading from ACC..." disabled>
                    </div>
                </div>
                <div class="form-group" style="margin-top: 1rem;">
                    <label for="notes">Notes</label>
                    <textarea id="notes" rows="2" placeholder="Additional notes or comments"></textarea>
                </div>
            </div>

            <!-- Calculators Grid -->
            <div class="calculator-content">
                <!-- Self-Stressing Calculator -->
                <div class="card">
                    <h2 class="calculator-title self-stress-title">Self-Stressing Bed Calculator</h2>

                    <!-- Inputs -->
                    <div id="selfStressInputs">
                        <div class="input-row">
                            <label class="input-label">Initial Pull:</label>
                            <input type="number" class="input-field" id="ss_initialPull" placeholder="0" oninput="calculateAll()">
                            <span class="input-unit">lbs</span>
                        </div>
                        <div class="input-row">
                            <label class="input-label">Required Force:</label>
                            <input type="number" class="input-field" id="ss_requiredForce" placeholder="0" oninput="calculateAll()">
                            <span class="input-unit">lbs</span>
                        </div>
                        <div class="input-row">
                            <label class="input-label">MOE:</label>
                            <input type="number" class="input-field" id="ss_MOE" placeholder="0" oninput="calculateAll()">
                            <span class="input-unit"></span>
                        </div>
                        <div class="input-row">
                            <label class="input-label"># of Strands:</label>
                            <input type="number" class="input-field" id="ss_numberOfStrands" placeholder="0" oninput="calculateAll()">
                            <span class="input-unit"></span>
                        </div>
                        <div class="input-row">
                            <label class="input-label">Adj Bed Short:</label>
                            <input type="number" class="input-field" id="ss_adjBedShortening" placeholder="0" oninput="calculateAll()">
                            <span class="input-unit">in</span>
                        </div>
                        <div class="input-row">
                            <label class="input-label">Block Length:</label>
                            <input type="number" class="input-field" id="ss_blockToBlockLength" placeholder="0" oninput="calculateAll()">
                            <span class="input-unit">ft</span>
                        </div>
                        <div class="input-row">
                            <label class="input-label">Strand Area:</label>
                            <input type="number" class="input-field" id="ss_strandArea" placeholder="0" oninput="calculateAll()">
                            <span class="input-unit">in²</span>
                        </div>
                        <div class="input-row">
                            <label class="input-label">Dead End Seat:</label>
                            <input type="number" class="input-field" id="ss_deadEndSeating" placeholder="0" oninput="calculateAll()">
                            <span class="input-unit">in</span>
                        </div>
                        <div class="input-row">
                            <label class="input-label">Live End Seat:</label>
                            <input type="number" class="input-field" id="ss_liveEndSeating" placeholder="0" oninput="calculateAll()">
                            <span class="input-unit">in</span>
                        </div>
                    </div>

                    <!-- Results -->
                    <div class="results self-stress-results">
                        <h4>Results</h4>
                        <div class="result-item">
                            <span>Basic Elongation:</span>
                            <span class="result-value" id="ss_basicElongation">0.000 in</span>
                        </div>
                        <div class="result-item">
                            <span>Bed Shortening:</span>
                            <span class="result-value" id="ss_bedShortening">0.000 in</span>
                        </div>
                        <div class="result-item critical-result">
                            <span>Desired Elongation (Rounded):</span>
                            <span class="result-value" id="ss_desiredElongationRounded">0.000 in</span>
                        </div>
                        <div class="result-item critical-result">
                            <span>Calculated Pull (Rounded):</span>
                            <span class="result-value" id="ss_calculatedPullRounded">0 lbs</span>
                        </div>
                    </div>
                </div>

                <!-- Non-Self-Stressing Calculator -->
                <div class="card">
                    <h2 class="calculator-title non-self-stress-title">Non-Self-Stressing Bed Calculator</h2>

                    <!-- Inputs -->
                    <div id="nonSelfStressInputs">
                        <div class="input-row">
                            <label class="input-label">Initial Pull:</label>
                            <input type="number" class="input-field" id="nss_initialPull" placeholder="0" oninput="calculateAll()">
                            <span class="input-unit">lbs</span>
                        </div>
                        <div class="input-row">
                            <label class="input-label">Required Force:</label>
                            <input type="number" class="input-field" id="nss_requiredForce" placeholder="0" oninput="calculateAll()">
                            <span class="input-unit">lbs</span>
                        </div>
                        <div class="input-row">
                            <label class="input-label">MOE:</label>
                            <input type="number" class="input-field" id="nss_MOE" placeholder="0" oninput="calculateAll()">
                            <span class="input-unit"></span>
                        </div>
                        <div class="input-row">
                            <label class="input-label">Block Length:</label>
                            <input type="number" class="input-field" id="nss_blockToBlockLength" placeholder="0" oninput="calculateAll()">
                            <span class="input-unit">ft</span>
                        </div>
                        <div class="input-row">
                            <label class="input-label">Strand Area:</label>
                            <input type="number" class="input-field" id="nss_strandArea" placeholder="0" oninput="calculateAll()">
                            <span class="input-unit">in²</span>
                        </div>
                        <div class="input-row">
                            <label class="input-label">Air Temp:</label>
                            <input type="number" class="input-field" id="nss_airTemp" placeholder="0" oninput="calculateAll()">
                            <span class="input-unit">°F</span>
                        </div>
                        <div class="input-row">
                            <label class="input-label">Concrete Temp:</label>
                            <input type="number" class="input-field" id="nss_concreteTemp" placeholder="0" oninput="calculateAll()">
                            <span class="input-unit">°F</span>
                        </div>
                        <div class="input-row">
                            <label class="input-label">Dead End Seat:</label>
                            <input type="number" class="input-field" id="nss_deadEndSeating" placeholder="0" oninput="calculateAll()">
                            <span class="input-unit">in</span>
                        </div>
                        <div class="input-row">
                            <label class="input-label">Live End Seat:</label>
                            <input type="number" class="input-field" id="nss_liveEndSeating" placeholder="0" oninput="calculateAll()">
                            <span class="input-unit">in</span>
                        </div>
                        <div class="input-row">
                            <label class="input-label">Total Abutment:</label>
                            <input type="number" class="input-field" id="nss_totalAbutmentRotation" placeholder="0" oninput="calculateAll()">
                            <span class="input-unit">in</span>
                        </div>
                    </div>

                    <!-- Results -->
                    <div class="results non-self-stress-results">
                        <h4>Results</h4>
                        <div class="result-item">
                            <span>Basic Elongation:</span>
                            <span class="result-value" id="nss_basicElongation">0.000 in</span>
                        </div>
                        <div class="result-item">
                            <span>Temp Difference:</span>
                            <span class="result-value" id="nss_tempDifference">0.000</span>
                        </div>
                        <div class="result-item">
                            <span>Temp Correction:</span>
                            <span class="result-value" id="nss_tempCorrection">0.000</span>
                        </div>
                        <div class="result-item critical-result">
                            <span>Desired Elongation (Rounded):</span>
                            <span class="result-value" id="nss_desiredElongationRounded">0.000 in</span>
                        </div>
                        <div class="result-item critical-result">
                            <span>Calculated Pull (Rounded):</span>
                            <span class="result-value" id="nss_calculatedPullRounded">0 lbs</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden PDF Content -->
    <div id="pdf-content">
        <div style="text-align: center; border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 20px;">
            <h1>Metromont CastLink Quality Control Report</h1>
            <p>Bed QC Report Analysis</p>
        </div>

        <div id="printMetadata" style="background: #e5f3ff; padding: 10px; border-radius: 5px; margin-bottom: 20px;">
            <!-- Metadata will be inserted here -->
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div>
                <h3 style="color: #2563eb; margin-bottom: 10px;">Self-Stressing Bed Calculator</h3>
                <div id="printSelfStressInputs" style="margin-bottom: 15px;">
                    <!-- Self-stress inputs will be inserted here -->
                </div>
                <div id="printSelfStressResults" style="background: #f8f9fa; padding: 10px; border-radius: 5px;">
                    <!-- Self-stress results will be inserted here -->
                </div>
            </div>

            <div>
                <h3 style="color: #059669; margin-bottom: 10px;">Non-Self-Stressing Bed Calculator</h3>
                <div id="printNonSelfStressInputs" style="margin-bottom: 15px;">
                    <!-- Non-self-stress inputs will be inserted here -->
                </div>
                <div id="printNonSelfStressResults" style="background: #f8f9fa; padding: 10px; border-radius: 5px;">
                    <!-- Non-self-stress results will be inserted here -->
                </div>
            </div>
        </div>
    </div>

    <script src="scripts/env.js"></script>
    <script src="scripts/quality-control.js"></script>
</body>
</html>