<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="frame-ancestors 'self' https://*.autodesk.com https://*.autodeskbim360.com https://*.acc.autodesk.com;">
    <title>Quality Control - PPPQC Stressing Calculator | Metromont CastLink</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            min-height: 100vh;
            color: #1a202c;
        }

        .header {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            padding: 0.75rem 0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo {
            height: 32px;
            width: auto;
        }

        .brand-text {
            color: white;
        }

        .brand-text h1 {
            font-size: 1.25rem;
            font-weight: 700;
            line-height: 1.2;
        }

        .brand-text p {
            font-size: 0.75rem;
            color: #cbd5e1;
            margin-top: 0.25rem;
        }

        .nav-breadcrumb {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #cbd5e1;
            font-size: 0.875rem;
        }

        .nav-breadcrumb a {
            color: #cbd5e1;
            text-decoration: none;
            transition: color 0.2s;
        }

        .nav-breadcrumb a:hover {
            color: white;
        }

        .header-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary { background: #3b82f6; color: white; }
        .btn-primary:hover:not(:disabled) { background: #2563eb; }
        .btn-save { background: #059669; color: white; }
        .btn-save:hover:not(:disabled) { background: #047857; }
        .btn-print { background: #3b82f6; color: white; }
        .btn-print:hover:not(:disabled) { background: #2563eb; }
        .btn-export { background: #8b5cf6; color: white; }
        .btn-export:hover:not(:disabled) { background: #7c3aed; }
        .btn-back { background: rgba(255, 255, 255, 0.1); color: white; }
        .btn-back:hover { background: rgba(255, 255, 255, 0.2); }
        .btn-secondary { background: #6b7280; color: white; }
        .btn-secondary:hover:not(:disabled) { background: #4b5563; }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
        }

        .page-header {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .page-title {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .page-title h2 {
            font-size: 1.75rem;
            font-weight: 700;
            color: #1e293b;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-connected {
            background: #dcfce7;
            color: #166534;
        }

        .status-disconnected {
            background: #fee2e2;
            color: #991b1b;
        }

        .tools-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .tool-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: all 0.3s ease;
            cursor: pointer;
            border: 1px solid #e2e8f0;
            position: relative;
            overflow: hidden;
        }

        .tool-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        .tool-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: #ef4444;
        }

        .tool-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1rem;
            color: white;
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        .tool-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 0.5rem;
        }

        .tool-description {
            color: #64748b;
            line-height: 1.5;
            margin-bottom: 1rem;
        }

        .tool-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .status-active {
            background: #dcfce7;
            color: #166534;
        }

        .status-development {
            background: #fef3c7;
            color: #92400e;
        }

        .acc-info {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border: 1px solid #7dd3fc;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }

        /* Auth Processing Overlay */
        .auth-processing {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .auth-processing.active {
            opacity: 1;
            visibility: visible;
        }

        .auth-processing-content {
            background: white;
            padding: 3rem;
            border-radius: 16px;
            text-align: center;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            max-width: 400px;
        }

        .auth-processing-content h3 {
            color: #1e293b;
            margin-bottom: 1rem;
            font-size: 1.5rem;
        }

        .auth-processing-content p {
            color: #64748b;
            margin-bottom: 1.5rem;
            line-height: 1.6;
        }

        .loading {
            display: inline-block;
            width: 32px;
            height: 32px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Hide main content during auth */
        .auth-loading .header,
        .auth-loading .container,
        .auth-loading .footer {
            opacity: 0.3;
            pointer-events: none;
        }

        /* Bed Selection Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }

        .modal-overlay.active .modal {
            transform: scale(1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #1e293b;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6b7280;
            padding: 0.5rem;
            border-radius: 50%;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: #f3f4f6;
            color: #374151;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
            margin-bottom: 0.5rem;
        }

        .form-group select, .form-group input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 0.875rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .form-group select:focus, .form-group input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .modal-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }

        /* Calculator Modal */
        .calculator-modal {
            max-width: 1400px;
            width: 95%;
            max-height: 95vh;
            padding: 1.5rem;
        }

        .calculator-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-top: 1rem;
        }

        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .grid {
            display: grid;
            gap: 1rem;
        }

        .grid-cols-3 {
            grid-template-columns: repeat(3, 1fr);
        }

        @media (max-width: 768px) {
            .grid-cols-3 {
                grid-template-columns: 1fr;
            }
            
            .calculator-content {
                grid-template-columns: 1fr;
            }
            
            .header-content {
                flex-direction: column;
                gap: 1rem;
            }
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .form-group label {
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
        }

        .form-group input, .form-group textarea, .form-group select {
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 0.875rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .form-group input:disabled, .form-group select:disabled {
            background-color: #f9fafb;
            color: #6b7280;
        }

        .input-row {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }

        .input-label {
            width: 140px;
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
            flex-shrink: 0;
        }

        .input-field {
            flex: 1;
            padding: 0.5rem 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.875rem;
        }

        .input-unit {
            width: 40px;
            font-size: 0.75rem;
            color: #6b7280;
            text-align: center;
            flex-shrink: 0;
        }

        .results {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
        }

        .results h4 {
            font-size: 1rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.75rem;
        }

        .result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            font-size: 0.875rem;
            border-bottom: 1px solid #e2e8f0;
        }

        .result-item:last-child {
            border-bottom: none;
        }

        .result-value {
            font-family: 'JetBrains Mono', 'Fira Code', 'Courier New', monospace;
            font-weight: 500;
            color: #1e293b;
        }

        .critical-result {
            font-weight: 600;
            color: #dc2626;
            background: #fef2f2;
            padding: 0.5rem;
            border-radius: 6px;
            margin: 0.25rem 0;
        }

        .self-stress-results {
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            border-color: #93c5fd;
        }

        .non-self-stress-results {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border-color: #86efac;
        }

        .calculator-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid #e2e8f0;
        }

        .self-stress-title {
            color: #2563eb;
            border-bottom-color: #2563eb;
        }

        .non-self-stress-title {
            color: #059669;
            border-bottom-color: #059669;
        }

        .report-header {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }

        .report-id {
            font-size: 0.875rem;
            color: #6b7280;
            font-family: 'JetBrains Mono', 'Fira Code', 'Courier New', monospace;
        }

        .bed-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #374151;
            font-weight: 500;
        }

        #pdf-content {
            display: none;
        }

        @media print {
            body * { visibility: hidden; }
            #pdf-content, #pdf-content * { visibility: visible; }
            #pdf-content { position: absolute; top: 0; left: 0; width: 100%; }
        }
    </style>
</head>
<body class="auth-loading">
    <!-- Auth Processing Overlay -->
    <div class="auth-processing active" id="authProcessing">
        <div class="auth-processing-content">
            <div class="loading"></div>
            <h3 id="authTitle">Verifying Authentication</h3>
            <p id="authMessage">Checking your Autodesk Construction Cloud connection...</p>
        </div>
    </div>
    <header class="header">
        <div class="header-content">
            <div class="logo-section">
                <img src="assets/images/metromont-logo.png" alt="Metromont Logo" class="logo" />
                <div class="brand-text">
                    <h1>Quality Control</h1>
                    <p>Manufacturing Quality Assurance</p>
                </div>
            </div>
            <div class="nav-breadcrumb">
                <a href="index.html">Dashboard</a>
                <span>→</span>
                <span>Quality Control</span>
            </div>
            <div class="header-buttons">
                <button class="btn btn-back" onclick="window.location.href='index.html'">
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
                    </svg>
                    Back to Dashboard
                </button>
                <div class="status-badge status-connected" id="authStatusBadge" style="display: none;">
                    <svg width="12" height="12" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                    </svg>
                    Connected to ACC
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="page-header">
            <div class="page-title">
                <svg width="32" height="32" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <h2>Quality Control Center</h2>
            </div>
            <p style="color: #64748b; font-size: 1rem;">Comprehensive quality assurance tools for precast concrete manufacturing operations.</p>
        </div>

        <!-- ACC Integration Status -->
        <div class="acc-info" id="accInfo">
            <div id="accDetails">
                <strong>Status:</strong> Connected to ACC<br>
                <strong>Authentication:</strong> Automatically verified<br>
                <strong>Hub:</strong> Metromont ACC Account
            </div>
        </div>

        <!-- Quality Control Tools -->
        <div class="tools-grid">
            <div class="tool-card" onclick="showBedSelection()">
                <div class="tool-icon">
                    <svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 002 2z"/>
                    </svg>
                </div>
                <h3 class="tool-title">New Bed Report</h3>
                <p class="tool-description">Generate PPPQC stressing calculations and quality reports for precast concrete bed operations.</p>
                <div class="tool-status">
                    <span class="status-badge status-active">Active</span>
                    <span style="margin-left: auto; color: #64748b;">PPPQC Calculator</span>
                </div>
            </div>

            <div class="tool-card" style="opacity: 0.6; cursor: not-allowed;">
                <div class="tool-icon">
                    <svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/>
                    </svg>
                </div>
                <h3 class="tool-title">Quality Inspection</h3>
                <p class="tool-description">Conduct comprehensive quality inspections with digital checklists and documentation.</p>
                <div class="tool-status">
                    <span class="status-badge status-development">In Development</span>
                    <span style="margin-left: auto; color: #64748b;">Q1 2025</span>
                </div>
            </div>

            <div class="tool-card" style="opacity: 0.6; cursor: not-allowed;">
                <div class="tool-icon">
                    <svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M16 4v12l-4-2-4 2V4M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                    </svg>
                </div>
                <h3 class="tool-title">Compliance Tracking</h3>
                <p class="tool-description">Monitor regulatory compliance, certifications, and quality standards adherence.</p>
                <div class="tool-status">
                    <span class="status-badge status-development">In Development</span>
                    <span style="margin-left: auto; color: #64748b;">Q2 2025</span>
                </div>
            </div>

            <div class="tool-card" style="opacity: 0.6; cursor: not-allowed;">
                <div class="tool-icon">
                    <svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"/>
                    </svg>
                </div>
                <h3 class="tool-title">Quality Analytics</h3>
                <p class="tool-description">Advanced analytics and reporting for quality trends, defect analysis, and process optimization.</p>
                <div class="tool-status">
                    <span class="status-badge status-development">In Development</span>
                    <span style="margin-left: auto; color: #64748b;">Q3 2025</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Bed Selection Modal -->
    <div class="modal-overlay" id="bedSelectionModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Select Production Bed</h3>
                <button class="modal-close" onclick="closeBedSelection()">&times;</button>
            </div>
            <div class="modal-content">
                <div class="form-group">
                    <label for="bedSelect">Choose the production bed for this report:</label>
                    <select id="bedSelect">
                        <option value="">Select a bed...</option>
                        <option value="beam">Beam</option>
                        <option value="deck1">Deck 1</option>
                        <option value="deck2">Deck 2</option>
                        <option value="flatbed1">Flat Bed #1</option>
                        <option value="flatbed2">Flat Bed #2</option>
                        <option value="flatbed3">Flat Bed #3</option>
                        <option value="flatbed4">Flat Bed #4</option>
                        <option value="flatbed5">Flat Bed #5</option>
                        <option value="flatbed6">Flat Bed #6</option>
                        <option value="flatbed7">Flat Bed #7</option>
                        <option value="pcbed1">PC Bed #1</option>
                        <option value="pcbed2">PC Bed #2</option>
                        <option value="pcbed3">PC Bed #3</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="reportDescription">Report Description (Optional):</label>
                    <input type="text" id="reportDescription" placeholder="e.g., Morning shift quality check">
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeBedSelection()">Cancel</button>
                <button class="btn btn-primary" onclick="startBedReport()">Start Report</button>
            </div>
        </div>
    </div>

    <!-- Calculator Modal -->
    <div class="modal-overlay" id="calculatorModal">
        <div class="modal calculator-modal">
            <div class="modal-header">
                <div>
                    <h3 class="modal-title">PPPQC Stressing Calculator</h3>
                    <div class="report-header">
                        <div class="bed-info">
                            <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
                            </svg>
                            <span id="selectedBedDisplay">No bed selected</span>
                        </div>
                        <div class="report-id">Report ID: <span id="reportId">-</span></div>
                    </div>
                </div>
                <div style="display: flex; gap: 0.5rem; align-items: center;">
                    <button class="btn btn-save" id="saveBtn" onclick="saveToACC()" disabled>
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/>
                        </svg>
                        Save to ACC
                    </button>
                    <button class="btn btn-print" onclick="generatePDF()">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M19 8H5c-1.66 0-3 1.34-3 3v6h4v4h12v-4h4v-6c0-1.66-1.34-3-3-3zm-3 11H8v-5h8v5zm3-7c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm-1-9H6v4h12V3z"/>
                        </svg>
                        Print Report
                    </button>
                    <button class="btn btn-export" id="exportBtn" onclick="exportToACCDocs()" disabled>
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
                        </svg>
                        Export to ACC
                    </button>
                    <button class="modal-close" onclick="closeCalculator()">&times;</button>
                </div>
            </div>

            <!-- Project Metadata -->
            <div class="card">
                <h3 class="card-title">
                    <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
                    </svg>
                    Project Information
                    <span id="projectSource" class="status-badge status-connected" style="margin-left: auto; display: none;">
                        Auto-populated from ACC
                    </span>
                </h3>
                <div class="grid grid-cols-3">
                    <div class="form-group">
                        <label for="projectName">Project Name</label>
                        <select id="projectName" onchange="onProjectSelected()" disabled>
                            <option value="">Loading projects from ACC...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="projectNumber">Project Number</label>
                        <input type="text" id="projectNumber" placeholder="Loading from ACC..." disabled>
                    </div>
                    <div class="form-group">
                        <label for="date">Date</label>
                        <input type="date" id="date">
                    </div>
                    <div class="form-group">
                        <label for="calculatedBy">Calculated By</label>
                        <input type="text" id="calculatedBy" placeholder="Loading from ACC..." disabled>
                    </div>
                    <div class="form-group">
                        <label for="reviewedBy">Reviewed By</label>
                        <input type="text" id="reviewedBy" placeholder="Reviewer name">
                    </div>
                    <div class="form-group">
                        <label for="location">Location</label>
                        <input type="text" id="location" placeholder="Loading from ACC..." disabled>
                    </div>
                </div>
                <div class="form-group" style="margin-top: 1rem;">
                    <label for="notes">Notes</label>
                    <textarea id="notes" rows="2" placeholder="Additional notes or comments"></textarea>
                </div>
            </div>

            <!-- Calculators Grid -->
            <div class="calculator-content">
                <!-- Self-Stressing Calculator -->
                <div class="card">
                    <h2 class="calculator-title self-stress-title">Self-Stressing Bed Calculator</h2>
                    
                    <!-- Inputs -->
                    <div id="selfStressInputs">
                        <div class="input-row">
                            <label class="input-label">Initial Pull:</label>
                            <input type="number" class="input-field" id="ss_initialPull" placeholder="0" oninput="calculateAll()">
                            <span class="input-unit">lbs</span>
                        </div>
                        <div class="input-row">
                            <label class="input-label">Required Force:</label>
                            <input type="number" class="input-field" id="ss_requiredForce" placeholder="0" oninput="calculateAll()">
                            <span class="input-unit">lbs</span>
                        </div>
                        <div class="input-row">
                            <label class="input-label">MOE:</label>
                            <input type="number" class="input-field" id="ss_MOE" placeholder="0" oninput="calculateAll()">
                            <span class="input-unit"></span>
                        </div>
                        <div class="input-row">
                            <label class="input-label"># of Strands:</label>
                            <input type="number" class="input-field" id="ss_numberOfStrands" placeholder="0" oninput="calculateAll()">
                            <span class="input-unit"></span>
                        </div>
                        <div class="input-row">
                            <label class="input-label">Adj Bed Short:</label>
                            <input type="number" class="input-field" id="ss_adjBedShortening" placeholder="0" oninput="calculateAll()">
                            <span class="input-unit">in</span>
                        </div>
                        <div class="input-row">
                            <label class="input-label">Block Length:</label>
                            <input type="number" class="input-field" id="ss_blockToBlockLength" placeholder="0" oninput="calculateAll()">
                            <span class="input-unit">ft</span>
                        </div>
                        <div class="input-row">
                            <label class="input-label">Strand Area:</label>
                            <input type="number" class="input-field" id="ss_strandArea" placeholder="0" oninput="calculateAll()">
                            <span class="input-unit">in²</span>
                        </div>
                        <div class="input-row">
                            <label class="input-label">Dead End Seat:</label>
                            <input type="number" class="input-field" id="ss_deadEndSeating" placeholder="0" oninput="calculateAll()">
                            <span class="input-unit">in</span>
                        </div>
                        <div class="input-row">
                            <label class="input-label">Live End Seat:</label>
                            <input type="number" class="input-field" id="ss_liveEndSeating" placeholder="0" oninput="calculateAll()">
                            <span class="input-unit">in</span>
                        </div>
                    </div>

                    <!-- Results -->
                    <div class="results self-stress-results">
                        <h4>Results</h4>
                        <div class="result-item">
                            <span>Basic Elongation:</span>
                            <span class="result-value" id="ss_basicElongation">0.000 in</span>
                        </div>
                        <div class="result-item">
                            <span>Bed Shortening:</span>
                            <span class="result-value" id="ss_bedShortening">0.000 in</span>
                        </div>
                        <div class="result-item critical-result">
                            <span>Desired Elongation (Rounded):</span>
                            <span class="result-value" id="ss_desiredElongationRounded">0.000 in</span>
                        </div>
                        <div class="result-item critical-result">
                            <span>Calculated Pull (Rounded):</span>
                            <span class="result-value" id="ss_calculatedPullRounded">0 lbs</span>
                        </div>
                    </div>
                </div>

                <!-- Non-Self-Stressing Calculator -->
                <div class="card">
                    <h2 class="calculator-title non-self-stress-title">Non-Self-Stressing Bed Calculator</h2>
                    
                    <!-- Inputs -->
                    <div id="nonSelfStressInputs">
                        <div class="input-row">
                            <label class="input-label">Initial Pull:</label>
                            <input type="number" class="input-field" id="nss_initialPull" placeholder="0" oninput="calculateAll()">
                            <span class="input-unit">lbs</span>
                        </div>
                        <div class="input-row">
                            <label class="input-label">Required Force:</label>
                            <input type="number" class="input-field" id="nss_requiredForce" placeholder="0" oninput="calculateAll()">
                            <span class="input-unit">lbs</span>
                        </div>
                        <div class="input-row">
                            <label class="input-label">MOE:</label>
                            <input type="number" class="input-field" id="nss_MOE" placeholder="0" oninput="calculateAll()">
                            <span class="input-unit"></span>
                        </div>
                        <div class="input-row">
                            <label class="input-label">Block Length:</label>
                            <input type="number" class="input-field" id="nss_blockToBlockLength" placeholder="0" oninput="calculateAll()">
                            <span class="input-unit">ft</span>
                        </div>
                        <div class="input-row">
                            <label class="input-label">Strand Area:</label>
                            <input type="number" class="input-field" id="nss_strandArea" placeholder="0" oninput="calculateAll()">
                            <span class="input-unit">in²</span>
                        </div>
                        <div class="input-row">
                            <label class="input-label">Air Temp:</label>
                            <input type="number" class="input-field" id="nss_airTemp" placeholder="0" oninput="calculateAll()">
                            <span class="input-unit">°F</span>
                        </div>
                        <div class="input-row">
                            <label class="input-label">Concrete Temp:</label>
                            <input type="number" class="input-field" id="nss_concreteTemp" placeholder="0" oninput="calculateAll()">
                            <span class="input-unit">°F</span>
                        </div>
                        <div class="input-row">
                            <label class="input-label">Dead End Seat:</label>
                            <input type="number" class="input-field" id="nss_deadEndSeating" placeholder="0" oninput="calculateAll()">
                            <span class="input-unit">in</span>
                        </div>
                        <div class="input-row">
                            <label class="input-label">Live End Seat:</label>
                            <input type="number" class="input-field" id="nss_liveEndSeating" placeholder="0" oninput="calculateAll()">
                            <span class="input-unit">in</span>
                        </div>
                        <div class="input-row">
                            <label class="input-label">Total Abutment:</label>
                            <input type="number" class="input-field" id="nss_totalAbutmentRotation" placeholder="0" oninput="calculateAll()">
                            <span class="input-unit">in</span>
                        </div>
                    </div>

                    <!-- Results -->
                    <div class="results non-self-stress-results">
                        <h4>Results</h4>
                        <div class="result-item">
                            <span>Basic Elongation:</span>
                            <span class="result-value" id="nss_basicElongation">0.000 in</span>
                        </div>
                        <div class="result-item">
                            <span>Temp Difference:</span>
                            <span class="result-value" id="nss_tempDifference">0.000</span>
                        </div>
                        <div class="result-item">
                            <span>Temp Correction:</span>
                            <span class="result-value" id="nss_tempCorrection">0.000</span>
                        </div>
                        <div class="result-item critical-result">
                            <span>Desired Elongation (Rounded):</span>
                            <span class="result-value" id="nss_desiredElongationRounded">0.000 in</span>
                        </div>
                        <div class="result-item critical-result">
                            <span>Calculated Pull (Rounded):</span>
                            <span class="result-value" id="nss_calculatedPullRounded">0 lbs</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden PDF Content -->
    <div id="pdf-content">
        <div style="text-align: center; border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 20px;">
            <h1>Metromont CastLink Quality Control Report</h1>
            <p>PPPQC Stressing Calculation Analysis</p>
        </div>
        
        <div id="printMetadata" style="background: #e5f3ff; padding: 10px; border-radius: 5px; margin-bottom: 20px;">
            <!-- Metadata will be inserted here -->
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div>
                <h3 style="color: #2563eb; margin-bottom: 10px;">Self-Stressing Bed Calculator</h3>
                <div id="printSelfStressInputs" style="margin-bottom: 15px;">
                    <!-- Self-stress inputs will be inserted here -->
                </div>
                <div id="printSelfStressResults" style="background: #f8f9fa; padding: 10px; border-radius: 5px;">
                    <!-- Self-stress results will be inserted here -->
                </div>
            </div>

            <div>
                <h3 style="color: #059669; margin-bottom: 10px;">Non-Self-Stressing Bed Calculator</h3>
                <div id="printNonSelfStressInputs" style="margin-bottom: 15px;">
                    <!-- Non-self-stress inputs will be inserted here -->
                </div>
                <div id="printNonSelfStressResults" style="background: #f8f9fa; padding: 10px; border-radius: 5px;">
                    <!-- Non-self-stress results will be inserted here -->
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // ACC CONNECT CONFIGURATION
        const ACC_CLIENT_ID = 'phUPKRBuqECpJUoBmRuKdKhSP3ZTRALH4LMWKAzAnymnYkQU';
        const ACC_CALLBACK_URL = 'https://metrocastpro.com/';
        
        // ACC/Forge Integration Variables
        let forgeAccessToken = null;
        let projectId = null;
        let hubId = null;
        let userProfile = null;
        let isACCConnected = false;
        let currentCalculation = null;
        let userProjects = [];

        // Form Instance Management
        let currentReportId = null;
        let currentBedId = null;
        let currentBedName = null;
        let reportInstances = new Map(); // Store multiple form instances

        // UI Elements
        const authProcessing = document.getElementById('authProcessing');
        const authTitle = document.getElementById('authTitle');
        const authMessage = document.getElementById('authMessage');

        // Authentication Flow
        async function initializeApp() {
            try {
                // Check if we're coming from the main app with authentication
                if (window.opener && window.opener.CastLinkAuth) {
                    const parentAuth = window.opener.CastLinkAuth;
                    const isParentAuth = await parentAuth.waitForAuth();
                    
                    if (isParentAuth) {
                        forgeAccessToken = parentAuth.getToken();
                        await completeAuthentication();
                        return;
                    }
                }
                
                // Check for stored authentication
                const storedToken = getStoredToken();
                if (storedToken && !isTokenExpired(storedToken)) {
                    forgeAccessToken = storedToken.access_token;
                    
                    // Verify token is still valid
                    const isValid = await verifyToken(forgeAccessToken);
                    if (isValid) {
                        await completeAuthentication();
                    } else {
                        // Token is invalid, redirect to main app for re-authentication
                        clearStoredToken();
                        redirectToMainApp();
                    }
                } else {
                    // No valid token, redirect to main app
                    redirectToMainApp();
                }
            } catch (error) {
                console.error('App initialization failed:', error);
                showAuthError(error.message);
            }
        }

        function redirectToMainApp() {
            updateAuthStatus('Redirecting to Login...', 'Taking you to the main app for authentication...');
            setTimeout(() => {
                window.location.href = 'index.html';
            }, 2000);
        }

        async function completeAuthentication() {
            try {
                updateAuthStatus('Loading Projects...', 'Connecting to your Autodesk Construction Cloud account...');
                
                // Load project data
                await loadRealProjectData();
                
                // Authentication complete
                isACCConnected = true;
                
                // Show success and hide auth overlay
                updateAuthStatus('Success!', 'Successfully connected to ACC');
                
                // Small delay to show success message
                await new Promise(resolve => setTimeout(resolve, 800));
                
                // Hide auth overlay and show main content
                authProcessing.classList.remove('active');
                document.body.classList.remove('auth-loading');
                
                // Show auth status badge
                document.getElementById('authStatusBadge').style.display = 'inline-flex';
                
                // Enable ACC features
                enableACCFeatures();
                
                console.log('Authentication completed successfully');
                
            } catch (error) {
                console.error('Authentication completion failed:', error);
                showAuthError('Failed to load project data: ' + error.message);
            }
        }

        async function verifyToken(token) {
            try {
                const response = await fetch('https://developer.api.autodesk.com/project/v1/hubs', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                return response.ok;
            } catch (error) {
                console.error('Token verification failed:', error);
                return false;
            }
        }

        function updateAuthStatus(title, message) {
            authTitle.textContent = title;
            authMessage.textContent = message;
        }

        function showAuthError(message) {
            updateAuthStatus('Authentication Error', message);
            authProcessing.innerHTML = `
                <div class="auth-processing-content">
                    <div style="color: #dc2626; font-size: 2rem; margin-bottom: 1rem;">⚠️</div>
                    <h3 style="color: #dc2626;">Authentication Error</h3>
                    <p style="color: #6b7280; margin-bottom: 1.5rem;">${message}</p>
                    <button onclick="window.location.href='index.html'" style="background: #059669; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-size: 0.875rem; margin-right: 0.5rem;">
                        Go to Main App
                    </button>
                    <button onclick="location.reload()" style="background: #6b7280; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-size: 0.875rem;">
                        Try Again
                    </button>
                </div>
            `;
        }

        // Token Management
        function getStoredToken() {
            // Try sessionStorage first, then localStorage
            let stored = sessionStorage.getItem('forge_token');
            if (!stored) {
                stored = localStorage.getItem('forge_token_backup');
                if (stored) {
                    // Restore to sessionStorage
                    sessionStorage.setItem('forge_token', stored);
                }
            }
            return stored ? JSON.parse(stored) : null;
        }

        function isTokenExpired(tokenInfo) {
            const now = Date.now();
            const expiresAt = tokenInfo.expires_at;
            const timeUntilExpiry = expiresAt - now;
            
            // Consider token expired if it expires in less than 5 minutes
            return timeUntilExpiry < (5 * 60 * 1000);
        }

        function clearStoredToken() {
            sessionStorage.removeItem('forge_token');
            localStorage.removeItem('forge_token_backup');
            console.log('Token cleared');
        }

        // Bed Selection Functions
        function showBedSelection() {
            document.getElementById('bedSelectionModal').classList.add('active');
        }

        function closeBedSelection() {
            document.getElementById('bedSelectionModal').classList.remove('active');
            document.getElementById('bedSelect').value = '';
            document.getElementById('reportDescription').value = '';
        }

        function startBedReport() {
            const bedSelect = document.getElementById('bedSelect');
            const bedId = bedSelect.value;
            const bedName = bedSelect.options[bedSelect.selectedIndex].text;
            const description = document.getElementById('reportDescription').value;

            if (!bedId) {
                alert('Please select a bed before continuing.');
                return;
            }

            // Generate unique report ID
            const reportId = generateReportId(bedId);
            
            // Store report instance
            currentReportId = reportId;
            currentBedId = bedId;
            currentBedName = bedName;

            // Initialize new form instance
            initializeFormInstance(reportId, bedId, bedName, description);

            // Close bed selection and show calculator
            closeBedSelection();
            showCalculator();
        }

        function generateReportId(bedId) {
            const timestamp = Date.now();
            const random = Math.random().toString(36).substr(2, 4);
            return `${bedId.toUpperCase()}-${timestamp}-${random}`;
        }

        function initializeFormInstance(reportId, bedId, bedName, description) {
            // Create new form instance data
            const formInstance = {
                id: reportId,
                bedId: bedId,
                bedName: bedName,
                description: description,
                timestamp: new Date().toISOString(),
                projectMetadata: {
                    projectName: '',
                    projectNumber: '',
                    date: new Date().toISOString().split('T')[0],
                    calculatedBy: '',
                    reviewedBy: '',
                    location: '',
                    notes: ''
                },
                calculations: {
                    selfStressing: {
                        inputs: {},
                        outputs: {}
                    },
                    nonSelfStressing: {
                        inputs: {},
                        outputs: {}
                    }
                }
            };

            // Store instance
            reportInstances.set(reportId, formInstance);

            // Update UI
            document.getElementById('reportId').textContent = reportId;
            document.getElementById('selectedBedDisplay').textContent = bedName;
        }

        function showCalculator() {
            document.getElementById('calculatorModal').classList.add('active');
            
            // Clear form data for new instance
            clearFormData();
            
            // Initialize calculations
            calculateAll();
        }

        function closeCalculator() {
            document.getElementById('calculatorModal').classList.remove('active');
            
            // Save current state to instance before closing
            if (currentReportId) {
                saveFormInstance();
            }
        }

        function clearFormData() {
            // Clear all input fields
            const inputs = document.querySelectorAll('#calculatorModal input[type="number"], #calculatorModal input[type="text"], #calculatorModal input[type="date"], #calculatorModal textarea, #calculatorModal select');
            inputs.forEach(input => {
                if (input.type === 'date') {
                    input.value = new Date().toISOString().split('T')[0];
                } else if (input.type === 'number') {
                    input.value = '';
                } else if (input.tagName === 'SELECT') {
                    input.selectedIndex = 0;
                } else {
                    input.value = '';
                }
            });
        }

        function saveFormInstance() {
            if (!currentReportId) return;

            const instance = reportInstances.get(currentReportId);
            if (!instance) return;

            // Update project metadata
            instance.projectMetadata = {
                projectName: document.getElementById('projectName').value,
                projectNumber: document.getElementById('projectNumber').value,
                date: document.getElementById('date').value,
                calculatedBy: document.getElementById('calculatedBy').value,
                reviewedBy: document.getElementById('reviewedBy').value,
                location: document.getElementById('location').value,
                notes: document.getElementById('notes').value
            };

            // Update calculations
            instance.calculations = currentCalculation;

            // Save back to storage
            reportInstances.set(currentReportId, instance);
        }

        // Modal click outside to close
        document.getElementById('bedSelectionModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeBedSelection();
            }
        });

        document.getElementById('calculatorModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeCalculator();
            }
        });

        // Project Data Loading
        async function loadRealProjectData() {
            try {
                console.log('Starting to load real project data...');
                
                const hubsResponse = await fetch('https://developer.api.autodesk.com/project/v1/hubs', {
                    headers: {
                        'Authorization': `Bearer ${forgeAccessToken}`
                    }
                });
                
                if (!hubsResponse.ok) {
                    const errorText = await hubsResponse.text();
                    console.error('Hubs response error:', hubsResponse.status, errorText);
                    throw new Error(`Failed to load hubs: ${hubsResponse.status} ${errorText}`);
                }
                
                const hubsData = await hubsResponse.json();
                console.log('Hubs data received:', hubsData);
                
                const accHubs = hubsData.data.filter(hub => 
                    hub.attributes.extension?.type === 'hubs:autodesk.bim360:Account'
                );
                
                console.log('ACC hubs found:', accHubs.length);
                
                if (accHubs.length > 0) {
                    const firstAccHub = accHubs[0];
                    console.log('Using ACC hub:', firstAccHub.attributes.name, firstAccHub.id);
                    
                    await loadProjectsFromHub(firstAccHub.id);
                } else {
                    console.warn('No ACC hubs found in response');
                    throw new Error('No ACC hubs found - only Fusion 360 hubs available');
                }
                
                console.log('Project data loading completed successfully');
                
            } catch (error) {
                console.error('Failed to load project data:', error);
                
                // Still enable manual entry mode
                const projectSelect = document.getElementById('projectName');
                projectSelect.innerHTML = '<option value="">Enter project details manually below...</option>';
                projectSelect.disabled = false;
                
                ['projectNumber', 'calculatedBy', 'location'].forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.disabled = false;
                        element.placeholder = element.placeholder.replace('Loading from ACC...', 'Enter manually');
                    }
                });
                
                document.getElementById('accDetails').innerHTML = `
                    <div style="color: #dc2626;">
                        <strong>Project Loading Issue:</strong> ${error.message}<br>
                        <small>You can still use the calculator by entering project details manually</small>
                    </div>
                `;
            }
        }

        async function loadProjectsFromHub(hubId) {
            try {
                console.log('Loading projects from ACC hub:', hubId);
                
                const projectsResponse = await fetch(`https://developer.api.autodesk.com/project/v1/hubs/${hubId}/projects`, {
                    headers: {
                        'Authorization': `Bearer ${forgeAccessToken}`
                    }
                });
                
                if (!projectsResponse.ok) {
                    throw new Error('Failed to load projects');
                }
                
                const projectsData = await projectsResponse.json();
                console.log('ACC projects data received:', projectsData);
                
                const projects = await Promise.all(projectsData.data.map(async (project) => {
                    console.log('Processing ACC project:', project.attributes.name);
                    
                    let projectNumber = '';
                    let location = '';
                    let additionalData = {};
                    
                    try {
                        const projectDetailResponse = await fetch(`https://developer.api.autodesk.com/project/v1/hubs/${hubId}/projects/${project.id}`, {
                            headers: {
                                'Authorization': `Bearer ${forgeAccessToken}`
                            }
                        });
                        
                        if (projectDetailResponse.ok) {
                            const projectDetail = await projectDetailResponse.json();
                            console.log('Project detail for', project.attributes.name, ':', projectDetail);
                            
                            if (projectDetail.data?.attributes?.extension?.data) {
                                const extData = projectDetail.data.attributes.extension.data;
                                
                                projectNumber = extData.projectNumber || 
                                              extData.project_number || 
                                              extData.number || 
                                              extData.jobNumber ||
                                              extData.job_number ||
                                              extData.projectId ||
                                              extData.project_id ||
                                              extData.accountId ||
                                              extData.projectCode ||
                                              extData.code || '';
                                
                                location = extData.location || 
                                         extData.project_location || 
                                         extData.address ||
                                         extData.city ||
                                         extData.state ||
                                         extData.jobLocation ||
                                         extData.site || '';
                            }
                        }
                    } catch (detailError) {
                        console.warn('Could not get detailed project info for', project.attributes.name, ':', detailError);
                    }
                    
                    if (!projectNumber && project.attributes.extension?.data) {
                        const extData = project.attributes.extension.data;
                        projectNumber = extData.projectNumber || 
                                      extData.project_number || 
                                      extData.number || 
                                      extData.projectId ||
                                      extData.project_id || '';
                    }
                    
                    if (!projectNumber) {
                        const namePatterns = [
                            /([A-Z]{2,}-\d+)/,
                            /(\d{4}-\d+)/,
                            /([A-Z]+\d+)/,
                            /(Job\s*\d+)/i,
                            /(\d{6,})/,
                            /([A-Z]{3,}\d{3,})/
                        ];
                        
                        for (const pattern of namePatterns) {
                            const match = project.attributes.name.match(pattern);
                            if (match) {
                                projectNumber = match[1];
                                break;
                            }
                        }
                    }
                    
                    if (!projectNumber) {
                        projectNumber = `ACC-${project.id.split('#').pop().slice(-6)}`;
                    }
                    
                    return {
                        id: project.id,
                        name: project.attributes.name || 'Unnamed Project',
                        number: projectNumber,
                        location: location || 'Location not specified',
                        additionalData,
                        fullData: project
                    };
                }));
                
                console.log('Processed ACC projects with enhanced metadata:', projects);
                
                populateProjectDropdown(projects);
                
                if (projects.length > 0) {
                    setTimeout(() => {
                        const projectSelect = document.getElementById('projectName');
                        if (projectSelect) {
                            projectSelect.value = projects[0].id;
                            onProjectSelected();
                        }
                    }, 100);
                }
                
            } catch (error) {
                console.error('Error in loadProjectsFromHub:', error);
                throw error;
            }
        }

        function populateProjectDropdown(projects) {
            try {
                console.log('Populating dropdown with ACC projects:', projects);
                
                userProjects = projects;
                const projectSelect = document.getElementById('projectName');
                
                if (!projectSelect) {
                    console.error('Project select element not found');
                    return;
                }
                
                projectSelect.innerHTML = '<option value="">Select an ACC project...</option>';
                
                projects.forEach((project, index) => {
                    console.log(`Adding ACC project ${index + 1}:`, project.name, 'Number:', project.number);
                    
                    const option = document.createElement('option');
                    option.value = project.id;
                    option.textContent = `${project.name} (${project.number})`;
                    option.dataset.projectNumber = project.number || '';
                    option.dataset.location = project.location || '';
                    projectSelect.appendChild(option);
                });
                
                projectSelect.disabled = false;
                projectSelect.style.backgroundColor = '';
                
                console.log('ACC project dropdown populated successfully');
                
                document.getElementById('accDetails').innerHTML = `
                    <strong>Status:</strong> Connected to ACC<br>
                    <strong>Projects Found:</strong> ${projects.length} ACC projects<br>
                    <strong>Hub:</strong> Metromont ACC Account
                `;
                
            } catch (error) {
                console.error('Error in populateProjectDropdown:', error);
                throw error;
            }
        }

        function onProjectSelected() {
            const projectSelect = document.getElementById('projectName');
            const selectedOption = projectSelect.selectedOptions[0];
            
            if (selectedOption && selectedOption.value) {
                const projectNumber = selectedOption.dataset.projectNumber || '';
                const location = selectedOption.dataset.location || '';
                
                console.log('Selected ACC project:', selectedOption.textContent);
                console.log('Project number:', projectNumber);
                console.log('Location:', location);
                
                document.getElementById('projectNumber').value = projectNumber;
                document.getElementById('location').value = location;
                
                document.getElementById('projectNumber').disabled = false;
                document.getElementById('location').disabled = false;
                document.getElementById('calculatedBy').disabled = false;
                
                document.getElementById('projectSource').style.display = 'inline-flex';
                document.getElementById('projectSource').textContent = 'Selected from ACC';
                
                if (!document.getElementById('calculatedBy').value) {
                    document.getElementById('calculatedBy').value = 'ACC User';
                }
            }
        }

        function enableACCFeatures() {
            document.getElementById('saveBtn').disabled = false;
            document.getElementById('exportBtn').disabled = false;
        }

        function setupUI() {
            const dateInput = document.getElementById('date');
            if (dateInput) {
                dateInput.value = new Date().toISOString().split('T')[0];
            }
        }

        // Utility functions
        function formatNumber(num) {
            if (isNaN(num) || !isFinite(num)) return '0.000';
            return num.toFixed(3);
        }

        function formatInteger(num) {
            if (isNaN(num) || !isFinite(num)) return '0';
            return Math.round(num).toString();
        }

        function getValue(id) {
            return parseFloat(document.getElementById(id).value) || 0;
        }

        // Calculation functions
        function calculateSelfStressing() {
            const ip = getValue('ss_initialPull');
            const rf = getValue('ss_requiredForce');
            const moe = getValue('ss_MOE') || 1;
            const ns = getValue('ss_numberOfStrands') || 1;
            const abs = getValue('ss_adjBedShortening');
            const btbl = getValue('ss_blockToBlockLength');
            const sa = getValue('ss_strandArea') || 1;
            const des = getValue('ss_deadEndSeating');
            const les = getValue('ss_liveEndSeating');

            const basicElongation = ((rf - ip) * btbl * 12) / (sa * moe);
            const bedShortening = (abs / 2) + (abs / ns);
            const desiredElongation = basicElongation + des + bedShortening;
            const desiredElongationRounded = Math.ceil(Math.round(desiredElongation * 1000) / 1000 * 8) / 8;
            const LESeatingAdd = basicElongation !== 0 ? (les / basicElongation) * (rf - ip) : 0;
            const bedShorteningAdd = basicElongation !== 0 ? (bedShortening / basicElongation) * (rf - ip) : 0;
            const desiredPull = rf + LESeatingAdd + bedShorteningAdd;
            const calculatedPullRounded = Math.ceil(Math.round(desiredPull) / 100) * 100;

            document.getElementById('ss_basicElongation').textContent = formatNumber(basicElongation) + ' in';
            document.getElementById('ss_bedShortening').textContent = formatNumber(bedShortening) + ' in';
            document.getElementById('ss_desiredElongationRounded').textContent = formatNumber(desiredElongationRounded) + ' in';
            document.getElementById('ss_calculatedPullRounded').textContent = formatInteger(calculatedPullRounded) + ' lbs';

            return {
                basicElongation, bedShortening, desiredElongation, desiredElongationRounded,
                LESeatingAdd, bedShorteningAdd, desiredPull, calculatedPullRounded
            };
        }

        function calculateNonSelfStressing() {
            const ip = getValue('nss_initialPull');
            const rf = getValue('nss_requiredForce');
            const moe = getValue('nss_MOE') || 1;
            const btbl = getValue('nss_blockToBlockLength');
            const sa = getValue('nss_strandArea') || 1;
            const at = getValue('nss_airTemp');
            const ct = getValue('nss_concreteTemp');
            const des = getValue('nss_deadEndSeating');
            const les = getValue('nss_liveEndSeating');
            const tar = getValue('nss_totalAbutmentRotation');

            const basicElongation = ((rf - ip) * btbl * 12) / (sa * moe);
            const tempDifference = (ct - at) / 1000;
            const tca2 = ((rf - ip) * btbl * 12) / (sa - moe) * tempDifference;
            const tcPart1 = tempDifference > 0.024 ? tca2 : 0;
            const tcPart2 = tempDifference < -0.024 ? basicElongation * tempDifference : 0;
            const tempCorrection = tcPart1 + tcPart2;
            const desiredElongation = basicElongation + des + tempCorrection;
            const desiredElongationRounded = Math.ceil(Math.round(desiredElongation * 1000) / 1000 * 8) / 8;
            const LESeatingAdd = basicElongation !== 0 ? (les / basicElongation) * (rf - ip) : 0;
            const tca1 = (rf + les + tar) * tempDifference;
            const tcPart1Pull = tempDifference > 0.024 ? tca1 : 0;
            const tcPart2Pull = tempDifference < -0.024 ? tca1 : 0;
            const tempCorrectionPull = tcPart1Pull + tcPart2Pull;
            const desiredPull = rf + LESeatingAdd + tempCorrectionPull;
            const calculatedPullRounded = Math.ceil(Math.round(desiredPull) / 100) * 100;

            document.getElementById('nss_basicElongation').textContent = formatNumber(basicElongation) + ' in';
            document.getElementById('nss_tempDifference').textContent = formatNumber(tempDifference);
            document.getElementById('nss_tempCorrection').textContent = formatNumber(tempCorrection);
            document.getElementById('nss_desiredElongationRounded').textContent = formatNumber(desiredElongationRounded) + ' in';
            document.getElementById('nss_calculatedPullRounded').textContent = formatInteger(calculatedPullRounded) + ' lbs';

            return {
                basicElongation, tempDifference, tca2, tcPart1, tcPart2, tempCorrection,
                desiredElongation, desiredElongationRounded, LESeatingAdd, tca1,
                tcPart1Pull, tcPart2Pull, tempCorrectionPull, desiredPull, calculatedPullRounded
            };
        }

        function calculateAll() {
            const selfStressingResults = calculateSelfStressing();
            const nonSelfStressingResults = calculateNonSelfStressing();
            
            currentCalculation = {
                timestamp: new Date().toISOString(),
                reportId: currentReportId,
                bedId: currentBedId,
                bedName: currentBedName,
                projectMetadata: {
                    projectName: document.getElementById('projectName').value,
                    projectNumber: document.getElementById('projectNumber').value,
                    date: document.getElementById('date').value,
                    calculatedBy: document.getElementById('calculatedBy').value,
                    reviewedBy: document.getElementById('reviewedBy').value,
                    location: document.getElementById('location').value,
                    notes: document.getElementById('notes').value
                },
                selfStressing: {
                    inputs: {
                        initialPull: getValue('ss_initialPull'),
                        requiredForce: getValue('ss_requiredForce'),
                        MOE: getValue('ss_MOE'),
                        numberOfStrands: getValue('ss_numberOfStrands'),
                        adjBedShortening: getValue('ss_adjBedShortening'),
                        blockToBlockLength: getValue('ss_blockToBlockLength'),
                        strandArea: getValue('ss_strandArea'),
                        deadEndSeating: getValue('ss_deadEndSeating'),
                        liveEndSeating: getValue('ss_liveEndSeating')
                    },
                    outputs: selfStressingResults
                },
                nonSelfStressing: {
                    inputs: {
                        initialPull: getValue('nss_initialPull'),
                        requiredForce: getValue('nss_requiredForce'),
                        MOE: getValue('nss_MOE'),
                        blockToBlockLength: getValue('nss_blockToBlockLength'),
                        strandArea: getValue('nss_strandArea'),
                        airTemp: getValue('nss_airTemp'),
                        concreteTemp: getValue('nss_concreteTemp'),
                        deadEndSeating: getValue('nss_deadEndSeating'),
                        liveEndSeating: getValue('nss_liveEndSeating'),
                        totalAbutmentRotation: getValue('nss_totalAbutmentRotation')
                    },
                    outputs: nonSelfStressingResults
                }
            };
        }

        // ACC Integration Functions
        async function saveToACC() {
            if (!isACCConnected) {
                alert('Not connected to ACC. Please check your connection.');
                return;
            }

            try {
                const saveBtn = document.getElementById('saveBtn');
                saveBtn.disabled = true;
                saveBtn.innerHTML = '<div class="loading"></div> Saving...';

                await new Promise(resolve => setTimeout(resolve, 1500));

                console.log('Saved to ACC:', currentCalculation);
                
                saveBtn.disabled = false;
                saveBtn.innerHTML = `
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/>
                    </svg>
                    Save to ACC
                `;
                
                alert('Calculation saved to ACC successfully!');
            } catch (error) {
                console.error('Save to ACC failed:', error);
                alert('Failed to save to ACC: ' + error.message);
                
                saveBtn.disabled = false;
                saveBtn.innerHTML = `
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/>
                    </svg>
                    Save to ACC
                `;
            }
        }

        async function exportToACCDocs() {
            if (!isACCConnected) {
                alert('Not connected to ACC. Please check your connection.');
                return;
            }

            try {
                const exportBtn = document.getElementById('exportBtn');
                exportBtn.disabled = true;
                exportBtn.innerHTML = '<div class="loading"></div> Exporting...';

                generatePDFData();

                await new Promise(resolve => setTimeout(resolve, 2000));

                exportBtn.disabled = false;
                exportBtn.innerHTML = `
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
                    </svg>
                    Export to ACC
                `;

                alert('Report exported to ACC Documents successfully!');
            } catch (error) {
                console.error('Export to ACC failed:', error);
                alert('Failed to export to ACC: ' + error.message);
            }
        }

        function generatePDF() {
            generatePDFData();
            window.print();
        }

        function generatePDFData() {
            const metadata = currentCalculation.projectMetadata;
            const selfStressingResults = currentCalculation.selfStressing.outputs;
            const nonSelfStressingResults = currentCalculation.nonSelfStressing.outputs;

            document.getElementById('printMetadata').innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                    <div><strong>Report ID:</strong> ${currentReportId}</div>
                    <div><strong>Bed:</strong> ${currentBedName}</div>
                    <div><strong>Date:</strong> ${metadata.date}</div>
                    <div><strong>Project:</strong> ${metadata.projectName}</div>
                    <div><strong>Project #:</strong> ${metadata.projectNumber}</div>
                    <div><strong>Location:</strong> ${metadata.location}</div>
                    <div><strong>Calculated By:</strong> ${metadata.calculatedBy}</div>
                    <div><strong>Reviewed By:</strong> ${metadata.reviewedBy}</div>
                    <div></div>
                </div>
                ${metadata.notes ? `<div><strong>Notes:</strong> ${metadata.notes}</div>` : ''}
            `;

            document.getElementById('printSelfStressInputs').innerHTML = `
                <h4>Input Values:</h4>
                <div><strong>Initial Pull:</strong> ${currentCalculation.selfStressing.inputs.initialPull} lbs</div>
                <div><strong>Required Force:</strong> ${currentCalculation.selfStressing.inputs.requiredForce} lbs</div>
                <div><strong>MOE:</strong> ${currentCalculation.selfStressing.inputs.MOE}</div>
                <div><strong># of Strands:</strong> ${currentCalculation.selfStressing.inputs.numberOfStrands}</div>
                <div><strong>Adjusted Bed Shortening:</strong> ${currentCalculation.selfStressing.inputs.adjBedShortening} inches</div>
                <div><strong>Block-to-Block Length:</strong> ${currentCalculation.selfStressing.inputs.blockToBlockLength} feet</div>
                <div><strong>Strand Area:</strong> ${currentCalculation.selfStressing.inputs.strandArea} sq inches</div>
                <div><strong>Dead-End Seating:</strong> ${currentCalculation.selfStressing.inputs.deadEndSeating} inches</div>
                <div><strong>Live End Seating:</strong> ${currentCalculation.selfStressing.inputs.liveEndSeating} inches</div>
            `;

            document.getElementById('printSelfStressResults').innerHTML = `
                <h4>Calculated Results:</h4>
                <div style="display: flex; justify-content: space-between;"><span>Basic Elongation:</span><span>${formatNumber(selfStressingResults.basicElongation)} inches</span></div>
                <div style="display: flex; justify-content: space-between;"><span>Bed Shortening:</span><span>${formatNumber(selfStressingResults.bedShortening)} inches</span></div>
                <div style="display: flex; justify-content: space-between; font-weight: bold; color: #dc2626;"><span>Desired Elongation (Rounded):</span><span>${formatNumber(selfStressingResults.desiredElongationRounded)} inches</span></div>
                <div style="display: flex; justify-content: space-between; font-weight: bold; color: #dc2626;"><span>Calculated Pull (Rounded):</span><span>${formatInteger(selfStressingResults.calculatedPullRounded)} lbs</span></div>
            `;

            document.getElementById('printNonSelfStressInputs').innerHTML = `
                <h4>Input Values:</h4>
                <div><strong>Initial Pull:</strong> ${currentCalculation.nonSelfStressing.inputs.initialPull} lbs</div>
                <div><strong>Required Force:</strong> ${currentCalculation.nonSelfStressing.inputs.requiredForce} lbs</div>
                <div><strong>MOE:</strong> ${currentCalculation.nonSelfStressing.inputs.MOE}</div>
                <div><strong>Block-to-Block Length:</strong> ${currentCalculation.nonSelfStressing.inputs.blockToBlockLength} feet</div>
                <div><strong>Strand Area:</strong> ${currentCalculation.nonSelfStressing.inputs.strandArea} sq inches</div>
                <div><strong>Air Temperature:</strong> ${currentCalculation.nonSelfStressing.inputs.airTemp} °F</div>
                <div><strong>Concrete Temperature:</strong> ${currentCalculation.nonSelfStressing.inputs.concreteTemp} °F</div>
                <div><strong>Dead-End Seating:</strong> ${currentCalculation.nonSelfStressing.inputs.deadEndSeating} inches</div>
                <div><strong>Live End Seating:</strong> ${currentCalculation.nonSelfStressing.inputs.liveEndSeating} inches</div>
                <div><strong>Total Abutment Rotation:</strong> ${currentCalculation.nonSelfStressing.inputs.totalAbutmentRotation} inches</div>
            `;

            document.getElementById('printNonSelfStressResults').innerHTML = `
                <h4>Calculated Results:</h4>
                <div style="display: flex; justify-content: space-between;"><span>Basic Elongation:</span><span>${formatNumber(nonSelfStressingResults.basicElongation)} inches</span></div>
                <div style="display: flex; justify-content: space-between;"><span>Temperature Difference:</span><span>${formatNumber(nonSelfStressingResults.tempDifference)}</span></div>
                <div style="display: flex; justify-content: space-between;"><span>Temperature Correction:</span><span>${formatNumber(nonSelfStressingResults.tempCorrection)}</span></div>
                <div style="display: flex; justify-content: space-between; font-weight: bold; color: #dc2626;"><span>Desired Elongation (Rounded):</span><span>${formatNumber(nonSelfStressingResults.desiredElongationRounded)} inches</span></div>
                <div style="display: flex; justify-content: space-between; font-weight: bold; color: #dc2626;"><span>Calculated Pull (Rounded):</span><span>${formatInteger(nonSelfStressingResults.calculatedPullRounded)} lbs</span></div>
            `;
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            setupUI();
            initializeApp();
        });
    </script>
</body>
</html>
